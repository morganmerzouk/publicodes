"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[364],{8418:(e,t,n)=>{n.d(t,{Z:()=>nt});var r=n(7092),a=n(3370),i=n(7378),s=n(4246),o=n(5404),l=n(1542),u=e=>{let{className:t}=e;return(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",height:"24px",viewBox:"0 0 24 24",width:"24px",fill:"#000000",className:t,role:"img",children:[(0,s.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,s.jsx)("path",{d:"M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"})]})},d=o.zo.div`
	overflow: hidden;
	border-radius: 6px;
	border: 1px solid #bbb;
`,c=o.zo.h4`
	font-size: 16px;
	font-weight: 700;
	margin: 2rem 0px 1rem;
	font-size: 1.25rem;
	line-height: 1.75rem;

	button {
		display: flex;
		flex-wrap: nowrap;
		flex-direction: row;
		align-content: center;
		align-items: center;
		justify-content: space-between;
		text-align: left;
		width: 100%;
		height: 50px;
		border: none;
		padding: 1.5rem;
		cursor: pointer;
		font-size: 1rem;
		font-weight: bold;

		&:hover {
			text-decoration: underline;
		}
	}
`,p=o.zo.div`
	border: 0 solid #bbb;
	${e=>{let{i:t}=e;return t>0&&o.iv`
			border-top-width: 1px;
		`}}

	& ${c} {
		margin: 0;
	}
`,m=o.zo.div`
	display: ${e=>{let{open:t}=e;return t?"block":"none"}};
	margin: 1.5rem;
`,h=(0,o.zo)(u)`
	display: inline-block;
	width: 25px;
	transition: transform 0.1s;
	height: 25px;
	transform: rotate(${e=>{let{$isOpen:t}=e;return t?"180deg":"360deg"}});
`,f=e=>{let{items:t}=e;const[n,r]=(0,i.useState)([]),a=e=>()=>r((t=>(t[e]=!t[e],[...t])));return(0,s.jsx)(d,{children:t.map(((e,t)=>{let{id:r,title:i,children:o}=e;return(0,s.jsxs)(p,{id:r,i:t,children:[(0,s.jsx)(c,{children:(0,s.jsxs)("button",{onClick:a(t),children:[(0,s.jsx)("span",{children:i}),(0,s.jsx)(h,{$isOpen:n[t]})]})}),(0,s.jsx)("div",{children:(0,s.jsx)(m,{open:!!n[t],children:o})})]},r)}))})},x=o.zo.div`
	position: relative;
	:hover button,
	:focus-within button {
		opacity: 1;
	}
`,v=o.zo.div`
	position: absolute;
	right: 0;
	top: 0;
	margin: 0.5rem;
	line-height: 0;

	& button {
		margin: 0;
		padding: 1px 3px;
		transition: opacity ease-in-out 0.1s;
		opacity: 0.25;

		:hover {
			cursor: pointer;
		}
		:not(:last-child) {
			margin-right: 0.5rem;
		}
	}
`,g=o.zo.pre`
	overflow: auto;
	padding: 0.5rem;
	background-color: #e6e9ec;
	border-radius: 0.25rem;
`,b=e=>{let{tabs:t}=e;const[n,r]=(0,i.useState)(),a=Object.keys(t),o=n??a[0];return(0,s.jsxs)(x,{children:[(0,s.jsxs)(v,{children:[navigator.clipboard&&(0,s.jsx)("button",{onClick:()=>navigator.clipboard.writeText(t[o]),children:"copier"}),a.length>1&&a.filter((e=>e!==o)).map((e=>(0,s.jsx)("button",{onClick:()=>r(e),children:e},e)))]}),(0,s.jsx)(g,{children:(0,s.jsx)("code",{children:t[o]})})]})};function y(e){let{references:t}=e;return t?(0,s.jsx)("ul",{children:Object.entries(t).map((e=>{let[t,n]=e;return(0,s.jsxs)("li",{style:{display:"flex",alignItems:"center"},children:[(0,s.jsx)("a",{href:n,target:"_blank",style:{marginRight:"1rem"},children:(0,a.Tt)(t)}),(0,s.jsx)("span",{className:"ui__ label",children:n})]},t)}))}):null}var j=e=>{let{children:t}=e;return(0,s.jsx)("p",{children:t})},N=e=>(0,s.jsx)("a",{...e}),w=function(e){void 0===e&&(e={});const t={References:y,Text:j,Code:b,Accordion:f,Link:N};return Object.fromEntries([...Object.keys(t),...Object.keys(e)].map((n=>[n,e[n]??t[n]])).filter((e=>{let[,t]=e;return t})))},V=(0,i.createContext)(w()),$=(0,i.createContext)("/documentation"),k=(0,i.createContext)(void 0),E=(0,i.createContext)(void 0),S=()=>{const e=(0,i.useContext)(E);if(!e)throw new Error("Engine expected");return e},R={"applicable si":"#7B1FA2","non applicable si":"#7B1FA2","est applicable":"#00796B","est non applicable":"#00796B","est d\xe9fini":"#00796B","est non d\xe9fini":"#00796B",somme:"#18457B",plafond:"#EF6C00",plancher:"#EF6C00",abattement:"#B73731",produit:"#2ecc71","une de ces conditions":"#3498db","toutes ces conditions":"#3498db","le maximum de":"#795548","le minimum de":"#795548",composantes:"#3498db",variations:"#FF9800","par d\xe9faut":"#00695C","taux progressif":"#795548","bar\xe8me":"#9B296F",grille:"#AD1457",avec:"#2653ce"},O=e=>R[e]||"palevioletred";var I=e=>{let{data:t,unit:n}=e;return(0,s.jsx)(C,{className:"node-value-pointer",children:(0,a.Bw)({nodeValue:t,unit:n})})},C=o.zo.span`
	background: white;
	border-bottom: 0 !important;
	font-size: 0.875rem;
	line-height: 1.25rem;
	margin: 0 0.2rem;
	flex-shrink: 0;
	padding: 0.1rem 0.2rem;
	text-decoration: none !important;
	box-shadow: 0px 1px 2px 1px #d9d9d9, 0 0 0 1px #d9d9d9;
	border: 1px solid #f8f9fa;
	border-radius: 0.2rem;
`;function P(e){let{name:t,value:n,children:r,unit:a,displayName:i=!0}=e;return(0,s.jsxs)(M,{mecanismName:t,children:[i&&(0,s.jsx)(D,{name:t,children:t}),(0,s.jsxs)("div",{children:[r,void 0!==n&&(0,s.jsxs)(A,{children:[(0,s.jsx)("small",{children:" =\xa0"}),(0,s.jsx)(I,{data:n,unit:a})]})]})]})}var A=o.zo.div`
	text-align: right;
	margin-top: 0.25rem;
	font-weight: bold;
`,_=e=>{let{value:t,prefixed:n,children:r}=e;return(0,s.jsxs)("div",{children:[n&&r,(0,s.jsx)("div",{className:"value",style:{position:"relative"},children:(0,s.jsx)(me,{node:t})}),!n&&r]})},T=e=>{let{name:t}=e;return(0,s.jsx)(D,{inline:!0,name:t,children:t})},D=e=>{let{name:t,inline:n=!1,children:r}=e;return(0,s.jsx)(s.Fragment,{children:(0,s.jsx)(L,{name:t,inline:n,target:"_blank",href:`https://publi.codes/docs/api/m\xe9canismes#${t}`,children:r})})},M=o.zo.div`
	border: 1px solid;
	max-width: 100%;
	border-radius: 3px;
	padding: 0.5rem 1rem;
	margin-bottom: 0.5rem;
	position: relative;
	flex: 1;
	flex-direction: column;
	text-align: left;
	border-color: ${e=>{let{mecanismName:t}=e;return O(t)}};
	.properties > li {
		margin: 1rem 0;
	}
`,L=o.zo.a`
	background-color: ${e=>{let{name:t}=e;return O(t)}} !important;
	font-size: inherit;
	display: inline-block;
	font-weight: inherit;
	width: fit-content;
	font-family: inherit;
	padding: 0.4rem 0.6rem !important;
	color: white !important;
	transition: hover 0.2s;
	:hover {
		color: white;
	}
	${e=>e.inline?o.iv`
					border-radius: 0.3rem;
					margin-bottom: 0.5rem;
			  `:o.iv`
					top: -0.5rem;
					position: relative;
					margin-left: -1rem;
					border-radius: 0 !important;
					border-bottom-right-radius: 0.3rem !important;
					::first-letter {
						text-transform: capitalize;
					}
			  `}
	:hover {
		opacity: 0.8;
	}
`,K=o.zo.div`
	font-weight: bold;
	:first-letter {
		text-transform: capitalize;
	}
`;var U=e=>{let{explanation:t}=e;const n=t.multiplicateur;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("li",{children:[(0,s.jsx)("span",{className:"key",children:"Assiette : "}),(0,s.jsx)("span",{className:"value",children:(0,s.jsx)(me,{node:t.assiette})})]},"assiette"),n&&!n.isDefault&&(0,s.jsxs)("li",{children:[(0,s.jsx)("span",{className:"key",children:"Multiplicateur : "}),(0,s.jsx)("span",{className:"value",children:(0,s.jsx)(me,{node:n})})]},"multiplicateur")]})},q=e=>{let{tranches:t,multiplicateur:n}=e;const r=t.find((e=>{let{isActive:t}=e;return t}));return(0,s.jsxs)("table",{className:"tranches",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Plafonds des tranches"}),t[0].taux&&(0,s.jsx)("th",{children:"Taux"}),(t[0].montant||null!=r?.nodeValue)&&(0,s.jsx)("th",{children:"Montant"})]})}),(0,s.jsx)("tbody",{children:t.map(((e,t)=>(0,s.jsx)(z,{tranche:e,multiplicateur:n},t)))})]})},z=e=>{let{tranche:t,multiplicateur:n}=e;const r=t.isActive;return(0,s.jsxs)("tr",{className:"tranche "+(r?"activated":""),children:[(0,s.jsx)("td",{children:t.plafond.nodeValue===1/0?"Au-del\xe0 du dernier plafond":(0,s.jsxs)(s.Fragment,{children:["Inf\xe9rieur \xe0 ",(0,s.jsx)(me,{node:t.plafond}),n&&!n.isDefault&&(0,s.jsxs)(s.Fragment,{children:[" \xd7 ",(0,s.jsx)(me,{node:n})]})]})},"tranche"),t.taux&&(0,s.jsx)("td",{children:(0,s.jsx)(me,{node:t.taux})},"taux"),(null!=t.nodeValue||t.montant)&&(0,s.jsx)("td",{children:t.montant?(0,s.jsx)(me,{node:t.montant}):(0,s.jsx)(I,{data:t.nodeValue,unit:t.unit})},"value")]})},F=o.zo.div`
	table {
		margin: 1em 0;
		width: 100%;
		text-align: left;
		font-weight: 400;
	}
	table td {
		padding: 0.1em 0.4em;
	}
	table th {
		font-weight: 600;
	}
	table th:first-letter {
		text-transform: uppercase;
	}
	.tranche:nth-child(2n) {
		background: var(--lightestColor);
	}
	.tranche.activated {
		background: var(--lighterColor);
		font-weight: bold;
	}
`,B=["z\xe9ro","un","deux","trois","quatre","cinq","six","sept","huit","neuf","dix"];var{encodeRuleName:W}=a.utils;function J(e){let{dottedName:t,engine:n,currentEngineId:r,documentationPath:o,displayIcon:l=!1,linkComponent:u,children:d,...c}=e;const p=(0,i.useContext)(V),m=a.utils.findCommonAncestor((0,i.useContext)(k)??t,t),h=u||p.Link;if(!h)throw new Error("You must provide a <Link /> component.");const f=n.context.parsedRules[t],x=o+"/"+W(t),v=[...a.utils.ruleParents(t).reverse().filter((e=>e.startsWith(`${m} . `))).map((e=>n.context.parsedRules[e]?.title.trim())),f.title?.trim()].join(" \u203a ");if(!f)throw new Error(`Unknown rule: ${t}`);return(0,s.jsxs)(h,{...c,"aria-label":c["aria-label"]??(f.title&&f.title+", voir les d\xe9tails du calcul pour : "+f.title),to:x+(r?`?currentEngineId=${r}`:""),children:[d||v||f.dottedName.split(" . ").slice(-1)[0]," ",l&&f.rawNode.ic\u00f4nes&&(0,s.jsx)("span",{children:f.rawNode.ic\u00f4nes})]})}function H(e){const t=S(),n=(0,i.useContext)($),r="undefined"!=typeof window&&new URLSearchParams(window.location.search).get("currentEngineId"),a=!1!==e.useSubEngine?t.subEngineId||(r?Number(r):void 0):void 0;return(0,s.jsx)(J,{engine:t,currentEngineId:a,documentationPath:n,...e})}var Z=(0,i.createContext)(!1),G=o.zo.button`
	text-transform: none !important;
	margin-left: 0.5rem;
`,X=o.zo.div`
	@media (max-width: 500px) {
		/* border: none; */
	}
	margin: 0.5rem;
	flex: 1;
	border-bottom: 2px dotted lightgray;
`;function Y(e){let{sourceMap:t,nodeValue:n,unit:r}=e;const{args:a,mecanismName:i}=t,o="valeur"in a&&i in a&&2===Object.keys(a).length,l="valeur"in a&&1===Object.keys(a).length;return(0,s.jsxs)(s.Fragment,{children:[o&&(0,s.jsx)(Q,{node:a.valeur}),(0,s.jsx)("div",{style:{paddingTop:"0.5rem"},children:(0,s.jsx)(P,{name:i,value:n,unit:r,children:o?(0,s.jsx)(Q,{node:a[i]}):l?(0,s.jsx)(Q,{node:a.valeur}):(0,s.jsx)("ul",{children:Object.entries(a).map((e=>{let[t,n]=e;return(0,s.jsxs)("li",{style:{display:"flex",alignItems:"baseline",padding:"0.25rem 0"},children:[(0,s.jsxs)("span",{children:[t,"\xa0:\xa0"]}),(0,s.jsx)("span",{children:(0,s.jsx)(Q,{node:n})})]},t)}))})})})]})}function Q(e){let{node:t}=e;return Array.isArray(t)?(0,s.jsx)(te,{explanation:t}):(0,s.jsx)(me,{node:t})}var ee=e=>{const t=(0,i.useContext)(E)?.evaluate(e).nodeValue;return null===t||0===t};function te(e){let{explanation:t}=e;const[n,r]=t.reduce(((e,t)=>(e[ee(t)?1:0].push(t),e)),[[],[]]),[a,o]=(0,i.useState)(0===n.length),l=(0,i.useMemo)((()=>"notApplicableExplanation"+Math.random().toString(36).substring(7)),[]);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(re,{children:n.map(((e,t)=>(0,s.jsx)(ae,{node:e},t)))}),r.length>0&&0!==n.length&&(0,s.jsx)(ne,{css:"\n\t\t\t\t\t\t\ttext-align: center;\n\t\t\t\t\t\t",children:(0,s.jsx)("button",{"aria-expanded":a,"aria-controls":l,onClick:()=>o(!a),children:a?"Cacher les valeurs non applicables":"Afficher les valeurs non applicables"})}),a&&(0,s.jsx)(re,{id:l,children:r.map(((e,t)=>(0,s.jsx)(ae,{node:e},t)))})]})}var ne=o.zo.div`
	margin: 0.5rem 0;
	margin-left: 1.5rem;
`,re=o.zo.ul`
	margin: 0;
	margin-left: 0.5rem;
	list-style: disc !important;
`;function ae(e){let{node:t}=e;return(0,s.jsx)(ie,{style:{padding:"0.25rem 0"},children:(0,s.jsx)(Z.Provider,{value:!0,children:(0,s.jsx)(me,{node:t})})})}var ie=o.zo.li`
	> * {
		width: 100%;
	}
`;var se=o.zo.div`
	display: flex;
	flex-wrap: wrap;
	gap: 0.125rem;
	> .operation ::before,
	> .operation ::after {
		content: '';
	}
	.result {
		margin-left: 0.2rem;
	}
	.operation .result {
		display: none;
	}
`;var oe=o.zo.small`
	display: flex;
	border-left: 2px solid lightgray;
	padding-left: 0.5rem;
	align-items: baseline;
	flex-wrap: wrap;
`;var le=o.zo.div`
	display: flex;
	flex-direction: column;

	border-top-left-radius: 3px;
	margin: 1rem 0;
	> small {
		align-self: flex-start;
		padding: 0.125rem 0.5rem;
		border: 1px solid #18457b;
		border-bottom: none;
		position: relative;
		color: #18457b;
		border-top-right-radius: 3px;
		border-top-left-radius: 3px;
		background-color: white;
	}
`,ue=o.zo.div`
	border: 1px solid #18457b;
	padding: 1rem;
`;var de=o.zo.span`
	border: 1px solid rgba(0, 0, 0, 0.1);
	padding: 0.2rem;
	position: relative;
	border-radius: 0.15rem;
	background-color: rgba(0, 0, 0, 0.05);
`;var ce=o.zo.div`
	.mecanism > ol {
		margin-left: 1rem;
		margin-top: 1rem;
	}
	.mecanism > ol > li {
		margin-bottom: 0.3em;
	}
	.mecanism > ol > li span.consequenceType {
		margin: 0 0.6em 0.6em 0;
	}

	.mecanism > ol > li span.consequenceType.satisfied {
		background: yellow;
	}
`,pe={constant:function(e){let{nodeValue:t,type:n,fullPrecision:r,unit:i}=e;return void 0===t?null:null===t?(0,s.jsx)("span",{className:"value",children:(0,a.Bw)({nodeValue:t})}):r?(0,s.jsx)("span",{className:n,children:(0,a.Bw)({nodeValue:t,unit:i},{precision:5})}):(0,s.jsx)("span",{className:"value",children:(0,a.Bw)({nodeValue:t,unit:i})})},arrondi:function(e){let{explanation:t}=e;return(0,s.jsx)(_,{value:t.valeur,children:(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Arrondi : "}),(0,s.jsx)(me,{node:t.arrondi})]})})},"bar\xe8me":function(e){let{nodeValue:t,explanation:n,unit:r}=e;return(0,s.jsx)(P,{name:"bar\xe8me",value:t,unit:r,children:(0,s.jsx)(F,{children:(0,s.jsxs)("ul",{className:"properties",children:[(0,s.jsx)(U,{explanation:n}),(0,s.jsx)(q,{tranches:n.tranches,multiplicateur:n.multiplicateur}),void 0!==t&&n.tranches.length>2&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("b",{children:"Taux moyen : "}),(0,s.jsx)(I,{data:100*t/n.assiette.nodeValue,unit:(0,a.n2)("%")})]})]})})})},avec:function(e){return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(me,{node:e.explanation.valeur}),(0,s.jsx)("div",{style:{paddingTop:"0.5rem"},children:(0,s.jsx)(P,{name:"avec",value:e.nodeValue,unit:e.unit,children:(0,s.jsx)("ul",{children:Object.entries(e.explanation.avec).map((e=>{let[t,n]=e;return(0,s.jsxs)("li",{children:[t,"\xa0= ",(0,s.jsx)(me,{node:n})]})}))})})})]})},composantes:function(e){let{nodeValue:t,explanation:n,unit:r,sourceMap:a}=e;return(0,s.jsxs)(P,{name:"composantes",displayName:!1,value:t,unit:r,children:[(0,s.jsxs)(K,{children:["La somme de ",B[n.length]," ",(0,s.jsx)(T,{name:"composantes"})," :"]}),(0,s.jsx)("ol",{children:a.args.valeur.map(((e,t)=>[(0,s.jsxs)("li",{children:[(0,s.jsx)(me,{node:e}),(0,s.jsx)("div",{style:{textAlign:"center",fontSize:"2.6rem",margin:"0.4em 0 0.2em"},children:t===n.length-1?null:"+"})]},t)]))})]})},"dur\xe9e":function(e){return(0,s.jsx)(Y,{...e,sourceMap:{mecanismName:e.nodeKind,args:e.explanation}})},produit:function(e){const t=e.sourceMap?.args??{};return(0,s.jsx)(P,{name:"produit",value:e.nodeValue,unit:e.unit,children:(0,s.jsxs)("div",{style:{display:"flex",alignItems:"baseline",justifyContent:"flex-start",flexWrap:"wrap"},children:[(0,s.jsxs)("div",{style:{textAlign:"right"},children:[(0,s.jsx)(me,{node:t.assiette}),t.plafond&&(0,s.jsxs)(oe,{children:[(0,s.jsx)("span",{children:"Plafonn\xe9e \xe0 :\xa0"}),(0,s.jsx)(me,{node:t.plafond})]})]}),t.facteur&&(0,s.jsxs)("div",{style:{display:"flex",alignItems:"baseline"},children:[(0,s.jsx)("div",{style:{fontSize:"110%",margin:"0 0.6rem"},children:" \xd7 "}),(0,s.jsx)("div",{children:(0,s.jsx)(me,{node:t.facteur})})]}),t.taux&&(0,s.jsxs)("div",{style:{display:"flex",alignItems:"baseline",justifyContent:"flex-end"},children:[(0,s.jsx)("div",{style:{fontSize:"110%",margin:"0 0.6rem"},children:" \xd7 "}),(0,s.jsx)(me,{node:t.taux})]})]})})},grille:function(e){let{nodeValue:t,explanation:n,unit:r}=e;return(0,s.jsx)(F,{children:(0,s.jsx)(P,{name:"grille",value:t,unit:r,children:(0,s.jsxs)("ul",{className:"properties",children:[(0,s.jsx)(U,{explanation:n}),(0,s.jsx)(q,{tranches:n.tranches,multiplicateur:n.multiplicateur})]})})})},inversion:function(e){let{nodeValue:t,explanation:n}=e;return(0,s.jsx)(P,{name:"inversion num\xe9rique",value:t,children:n.inversionFailed?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("p",{children:"Cette valeur devrait pouvoir \xeatre estim\xe9e \xe0 partir d'une autre variable qui poss\xe8de une formule de calcul et dont la valeur a \xe9t\xe9 fix\xe9e dans la simulation :"}),(0,s.jsx)(me,{node:n.inversionGoal}),(0,s.jsx)("p",{children:"Malheureusement, il a \xe9t\xe9 impossible de retrouver une valeur pour cette formule qui permette d'atterrir sur la valeur demand\xe9e."})]}):n.inversionGoal?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("p",{children:"Cette valeur a \xe9t\xe9 estim\xe9e \xe0 partir d'une autre variable qui poss\xe8de une formule de calcul et dont la valeur a \xe9t\xe9 fix\xe9e dans la simulation :"}),(0,s.jsx)(me,{node:n.inversionGoal})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("p",{children:"Cette formule de calcul n'existe pas, mais on peut la calculer par inversion en utilisant les formules des r\xe8gles suivantes :"}),(0,s.jsx)("ul",{id:"inversionsPossibles",children:n.inversionCandidates.map((e=>(0,s.jsx)("li",{children:(0,s.jsx)(me,{node:e})},e.dottedName)))})]})})},operation:function(e){let{nodeValue:t,explanation:n,operator:r,unit:a}=e;const i=0===n[0].nodeValue&&"\u2212"===r&&"constant"===n[0].nodeKind;return(0,s.jsxs)(se,{className:"operation",role:"math",children:[(0,s.jsx)("span",{children:"("}),!i&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(me,{node:n[0]}),"\xa0"]}),r,"\xa0",(0,s.jsx)(me,{node:n[1]}),null!=t&&(0,s.jsxs)("span",{className:"result",children:[(0,s.jsx)("small",{children:" =\xa0"}),(0,s.jsx)(I,{data:t,unit:a})]}),(0,s.jsx)("span",{children:")"})]})},texte:function(e){let{nodeValue:t,unit:n,explanation:r}=e;return(0,s.jsx)("p",{children:r.map((e=>"string"==typeof e?e:(0,s.jsx)(de,{children:(0,s.jsx)(me,{node:e})})))})},reference:function(e){const t=(0,i.useContext)(E),{dottedName:n,nodeValue:r,unit:a}=e,o=t?.context.parsedRules[e.dottedName];if(!o)throw new Error(`Unknown rule: ${n}`);const[l,u]=(0,i.useState)(!0),d=(0,i.useContext)(Z);return e.dottedName===e.contextDottedName+" . "+e.name&&!e.name.includes(" . ")&&o.virtualRule?(0,s.jsx)(me,{node:t?.evaluate(o)}):(0,s.jsxs)("div",{style:{display:"flex",flex:d?1:"initial",flexDirection:"column",maxWidth:"100%"},children:[(0,s.jsxs)("div",{style:{display:"flex",alignItems:"baseline",flexWrap:"wrap",justifyContent:"space-between"},children:[(0,s.jsx)(H,{dottedName:n}),(0,s.jsxs)("div",{style:{flex:1,display:"flex",alignItems:"baseline"},children:[d&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(G,{onClick:()=>u(!l),"aria-expanded":!l,"aria-label":l?"D\xe9plier, afficher le d\xe9tail":"Replier, afficher le d\xe9tail",children:l?"D\xe9plier":"Replier"}),(0,s.jsx)(X,{})]}),void 0!==r&&(0,s.jsx)(I,{data:r,unit:a})]})]})," ",!l&&(0,s.jsx)("div",{children:(0,s.jsx)(Z.Provider,{value:!1,children:(0,s.jsx)(me,{node:t?.evaluate(o)})})})]})},"est non applicable":function(e){return(0,s.jsx)(Y,{...e,sourceMap:{mecanismName:e.nodeKind,args:{valeur:e.explanation}}})},"est non d\xe9fini":function(e){return(0,s.jsx)(Y,{...e,sourceMap:{mecanismName:e.nodeKind,args:{valeur:e.explanation}}})},rule:function(e){let{rawNode:t,explanation:n,dottedName:r,title:i,virtualRule:o}=e;return(0,s.jsx)(le,{children:(0,s.jsxs)(k.Provider,{value:r,children:[(0,s.jsx)("small",{children:(0,a.Tt)(o?t.nom:i)}),(0,s.jsx)(ue,{children:(0,s.jsx)(me,{node:n.valeur})})]})})},condition:function(e){return(0,s.jsx)(Y,{...e,sourceMap:{mecanismName:e.nodeKind,args:e.explanation}})},"dans la situation":function(e){let{sourceMap:t}=e;const n=(0,i.useContext)(E),r=n?.evaluate(t.args["dans la situation"]);return void 0!==r?.nodeValue?(0,s.jsx)(_,{prefixed:!0,value:t.args.valeur,children:(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Valeur renseign\xe9e dans la simulation : "}),(0,s.jsx)(me,{node:r.explanation.valeur})]})}):(0,s.jsx)(me,{node:t.args.valeur})},recalcul:function(e){let{nodeValue:t,explanation:n,unit:r}=e;const a=S(),i=n.subEngineId?a.subEngines[n.subEngineId]:a;return(0,s.jsx)(P,{name:"recalcul",value:t,unit:r,children:(0,s.jsxs)(s.Fragment,{children:[n.recalculNode&&(0,s.jsxs)(E.Provider,{value:i,children:["Recalcul de la valeur de"," ",(0,s.jsx)(me,{node:n.recalculNode})," avec la situation suivante :"]}),(0,s.jsx)("ul",{children:n.amendedSituation.map((e=>{let[t,n]=e;return(0,s.jsxs)("li",{children:[(0,s.jsx)(H,{dottedName:t.dottedName})," ="," ",(0,s.jsx)(me,{node:n})]},t.dottedName)}))})]})})},replacement:function(e){const t=e.explanation.find((e=>{let{condition:t}=e;return"nodeValue"in t&&!1!==t.nodeValue&&null!==t.nodeValue}))?.consequence,n=e.explanation.slice(-1)[0].consequence;return(0,s.jsx)(me,{node:t??n})},replacementRule:function(e){return(0,s.jsxs)("span",{children:["Remplace ",(0,s.jsx)(me,{node:e.replacedReference})," ",e.rawNode.par&&(0,s.jsxs)(s.Fragment,{children:["par ",(0,s.jsx)(me,{node:e.replacementNode})]}),e.rawNode.dans&&(0,s.jsxs)(s.Fragment,{children:["dans"," ",e.whiteListedNames.map(((e,t)=>(0,s.jsx)(me,{node:e},t))).join(", ")]}),e.rawNode["sauf dans"]&&(0,s.jsxs)(s.Fragment,{children:["sauf dans"," ",e.blackListedNames.map(((e,t)=>(0,s.jsx)(me,{node:e},t))).join(", ")]})]})},"taux progressif":function(e){let{nodeValue:t,explanation:n,unit:r}=e;return(0,s.jsx)(F,{children:(0,s.jsx)(P,{name:"taux progressif",value:t,unit:r,children:(0,s.jsxs)("ul",{className:"properties",children:[(0,s.jsx)(U,{explanation:n}),(0,s.jsx)(q,{tranches:n.tranches,multiplicateur:n.multiplicateur})]})})})},"une possibilit\xe9":function(e){let{explanation:t}=e;return(0,s.jsx)(P,{name:"une possibilit\xe9 parmi",value:void 0,children:(0,s.jsx)("ul",{children:t.map(((e,t)=>(0,s.jsx)("li",{children:(0,s.jsx)(me,{node:e})},t)))})})},"r\xe9soudre r\xe9f\xe9rence circulaire":function(e){let{explanation:t}=e;return(0,s.jsxs)(P,{name:"r\xe9soudre la r\xe9f\xe9rence circulaire",value:t.valeur,children:[(0,s.jsxs)("p",{children:[" ","Cette valeur a \xe9t\xe9 retrouv\xe9 en r\xe9solvant la r\xe9f\xe9rence circulaire dans la formule ci dessous :"," "]}),(0,s.jsx)(me,{node:t.valeur})]})},"unit\xe9":function(e){let{nodeValue:t,explanation:n,unit:r}=e;return"constant"===n.nodeKind?(0,a.Bw)({nodeValue:t,unit:r}):"reference"===n.nodeKind?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(me,{node:n}),"\xa0",(0,a.gL)(r)]}):(0,s.jsx)(_,{value:n,children:(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:"Unit\xe9 : "}),(0,a.gL)(r)]})})},"variable manquante":e=>(0,s.jsx)(me,{node:e.explanation}),variations:function(e){let{nodeValue:t,explanation:n,unit:r}=e;const[a,o]=(0,i.useState)(void 0);return(0,s.jsx)(ce,{children:(0,s.jsx)(P,{name:"variations",displayName:!1,unit:r,value:t,children:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(K,{children:[B[n.length]," ",(0,s.jsx)(T,{name:"variations"})," possibles :"]}),(0,s.jsx)("ol",{children:n.map(((e,n)=>{let{condition:r,consequence:i}=e;const l="nodeValue"in r&&!1!==r.nodeValue&&null!==r.nodeValue;return(0,s.jsxs)("li",{style:{transition:"all 0.2s",opacity:a===n||l||null==t?1:.8},children:[!l&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("em",{children:"non applicable "}),a!==n?(0,s.jsx)("button",{className:"ui__ link-button",onClick:()=>o(n),children:"d\xe9tails \u25b6\ufe0f"}):(0,s.jsx)("button",{className:"ui__ link-button",onClick:()=>o(void 0),children:"replier \ud83d\udd3d"})]}),(a===n||l)&&(0,s.jsxs)("div",{style:{margin:"1rem 0"},children:[!r.isDefault&&(0,s.jsxs)("div",{style:{display:"flex",flexWrap:"wrap",alignItems:"baseline",marginBottom:"0.4rem"},children:["Si :\xa0",(0,s.jsx)(me,{node:r})]}),(0,s.jsxs)("div",{style:{display:"flex",width:"fit-content",flexWrap:"wrap",alignItems:"baseline"},children:[(0,s.jsxs)("span",{className:"consequenceType "+(l?"satisfied":""),children:[r.isDefault?"Sinon":"Alors"," :\xa0"]}),(0,s.jsx)("span",{className:"consequenceContent "+(l?"satisfied":""),children:i&&(0,s.jsx)(me,{node:i})})]})]})]},n)}))})]})})})}};function me(e){let{node:t}=e;const n=t.sourceMap?.mecanismName??t.nodeKind,r=S(),i=(0,a.fk)((e=>!("nodeValue"in e)&&"replacementRule"!==e.nodeKind&&r.evaluateNode(e)),!1)(t),o=pe[n]??(t.sourceMap?.mecanismName?Y:void 0);if(!o)throw new Error(`Unknown visualisation: ${n}`);return(0,s.jsx)(o,{...i})}var{encodeRuleName:he}=a.utils;function fe(e){let{engine:t,dottedName:n}=e;const r=xe(t,n);if("undefined"!=typeof window&&"publi.codes"===window.location.host)return null;const a="Afficher la r\xe8gle dans le bac \xe0 sable Publicodes";return(0,s.jsx)("p",{style:{textAlign:"right"},children:(0,s.jsxs)("a",{target:"_blank",href:r,"aria-label":`${a}, nouvelle fen\xeatre`,children:[(0,s.jsx)("span",{"aria-hidden":!0,children:"\u270d\ufe0f"})," ",a]})})}var xe=(e,t)=>{const n=Array.from(e.context.referencesMaps.referencesIn.get(t)??[]),r=e.evaluateNode(e.context.parsedRules[t]),a={[t]:Object.fromEntries(Object.entries(r.rawNode).filter((e=>{let[t]=e;return"nom"!==t})))},i=Object.fromEntries(n.filter((e=>e!==t&&!e.endsWith(" . $SITUATION"))).map((e=>[e,ve(r)]))),s=encodeURIComponent(JSON.stringify({rules:a,situation:i}));return`${"localhost"===location.hostname?"":"https://publi.codes"}/studio/${he(t)}#${s}`};function ve(e){const t=(0,a.Bw)(e).replace(/\s\/\s/g,"/").replace(/(\d)\s(\d)/g,"$1$2").replace(",",".");return t.match(/^[0-9]/)||"Oui"===t||"Non"===t?t.toLowerCase():"-"===t?"non":`'${t}'`}var ge=o.zo.ul`
	padding: 0;
	max-height: 400px;
	overflow: auto;
	list-style: none;
`,be=o.zo.li`
	position: relative;
	padding-left: 1.5rem;

	&::before {
		content: 'â—';
		font-size: 80%;
		display: inline-block;
		position: absolute;
		left: 0;
		width: 1.5rem;
		text-align: center;
		color: #b3b3b3;
		margin-bottom: 0.5rem;
	}
`;function ye(e){let{rule:t,engine:n,dottedName:r,situation:o={},apiDocumentationUrl:l,apiEvaluateUrl:u,npmPackage:d}=e;const{Accordion:c}=(0,i.useContext)(V),p=[{title:"R\xe8gle et situation",id:"rule-situation",children:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(je,{engine:n,dottedName:r}),(0,s.jsx)(Ne,{situation:o})]})},l&&u||d?{title:"R\xe9utiliser ce calcul ("+[l&&u?"API REST":null,d?"Paquet NPM":null].filter((e=>null!==e)).join(" / ")+")",id:"usage",children:(0,s.jsxs)(s.Fragment,{children:[a.utils.isExperimental(n.baseContext.parsedRules,r)&&(0,s.jsxs)(Ce,{children:[(0,s.jsx)("h4",{children:"\u26a0\ufe0f Cette r\xe8gle est taggu\xe9e comme experimentale \u26a0\ufe0f"}),(0,s.jsx)("p",{children:"Cela veut dire qu'elle peut \xeatre modifi\xe9e, renomm\xe9e, ou supprim\xe9e sans qu'il n'y ait de changement de version majeure dans l'API."})]}),d&&(0,s.jsx)($e,{rule:t,situation:o,dottedName:r,npmPackage:d}),l&&u&&(0,s.jsx)(Ee,{situation:o,dottedName:r,apiDocumentationUrl:l,apiEvaluateUrl:u})]})}:null,{title:"D\xe9pendances et effets de la r\xe8gle",id:"dependencies-effects",children:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(Se,{selfMissing:Object.keys(t.missingVariables)}),(0,s.jsx)(Oe,{engine:n,dottedName:r,ruleIsNotDefined:void 0===t.nodeValue}),(0,s.jsx)(Ie,{engine:n,dottedName:r,replacements:t.replacements})]})}].filter((e=>null!==e));return(0,s.jsx)(c,{items:p})}function je(e){let{engine:t,dottedName:n}=e;const{Code:r}=(0,i.useContext)(V);return(0,s.jsxs)("section",{children:[(0,s.jsx)("h4",{children:"R\xe8gle actuelle"}),(0,s.jsx)(r,{tabs:{dottedName:n}}),(0,s.jsx)(fe,{dottedName:n,engine:t})]})}function Ne(e){let{situation:t}=e;const{Code:n}=(0,i.useContext)(V),r=Object.keys(t),a={json:JSON.stringify(t,null,2)};return(0,s.jsxs)("section",{children:[(0,s.jsx)("h4",{children:"Situation actuelle"}),r.length?(0,s.jsx)("p",{children:"Voici les donn\xe9es que vous avez saisies dans notre simulateur sous forme de JSON."}):(0,s.jsx)("p",{children:"Votre situation est pour l'instant vide, vous n'avez probablement pas encore fait de simulation."}),(0,s.jsx)(n,{tabs:a})]})}var we="Retrouvez ce paquet sur NPM",Ve="moteur Publicodes";function $e(e){let{rule:t,situation:n,dottedName:r,npmPackage:a}=e;const{Code:o,Link:l}=(0,i.useContext)(V),u={npmPackage:`// npm i publicodes ${a}\n\nimport Engine, { formatValue } from 'publicodes'\nimport rules from '${a}'\n\nconst engine = new Engine(rules)\nengine.setSituation(${JSON.stringify(n,null,2)})\n\n// ${t.title}\nconst evaluation = engine.evaluate(${JSON.stringify(r)})\n\nconsole.log(formatValue(evaluation))\n`};return(0,s.jsxs)("section",{children:[(0,s.jsx)("h4",{children:"Lancer un calcul avec Publicodes"}),(0,s.jsxs)("p",{children:["Vous pouvez installer notre package de r\xe8gles pour l'utiliser avec le"," ",(0,s.jsx)(l,{"aria-label":`${Ve}, acc\xe9der au site publi.codes, nouvelle fen\xeatre`,href:"https://publi.codes/",children:Ve})," ","et ainsi effectuer vos propres calculs. Voici un exemple avec votre situation et la r\xe8gle actuelle :"]}),(0,s.jsx)(o,{tabs:u}),(0,s.jsx)("p",{style:{textAlign:"right"},children:(0,s.jsxs)(l,{href:"https://www.npmjs.com/package/"+a,"aria-label":`${we}, acc\xe9der \xe0 la page npm du package Publicodes, nouvelle fen\xeatre`,children:[(0,s.jsx)("span",{"aria-hidden":!0,children:"\ud83d\udce6"})," ",we]})})]})}var ke="En savoir plus sur notre API REST";function Ee(e){let{situation:t,dottedName:n,apiDocumentationUrl:r,apiEvaluateUrl:a}=e;const{Code:o,Link:l}=(0,i.useContext)(V),u={expressions:[n],situation:t},d={curl:`curl '${a}' \\\n  -H 'accept: application/json' \\\n  -H 'content-type: application/json' \\\n  --data-raw $'${JSON.stringify(u).replace(/'/g,"'\\''")}' \\\n  --compressed`,"fetch js":`const request = await fetch("${a}", {\n  "headers": { "content-type": "application/json" },\n  "method": "POST",\n  "body": JSON.stringify(${JSON.stringify(u,null,2)}),\n})\nconst { evaluate } = await request.json()\n\nconsole.log(evaluate)`};return(0,s.jsxs)("section",{children:[(0,s.jsx)("h4",{children:"Utiliser notre API REST"}),(0,s.jsx)("p",{children:"Vous trouverez ici un exemple d'utilisation de notre API REST via curl ou un fetch javascript."}),(0,s.jsx)(o,{tabs:d}),r&&(0,s.jsx)("p",{style:{textAlign:"right"},children:(0,s.jsxs)(l,{to:r,"aria-label":`${ke}, acc\xe9der \xe0 la documentation, nouvelle fen\xeatre`,children:[(0,s.jsx)("span",{"aria-hidden":!0,children:"\ud83d\udc69\u200d\ud83d\udcbb"})," ",ke]})})]})}function Se(e){let{selfMissing:t}=e;return(0,s.jsxs)("section",{children:[(0,s.jsx)("h4",{children:"Donn\xe9es manquantes"}),t?.length?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("p",{children:"Les r\xe8gles suivantes sont n\xe9cessaires pour le calcul mais n'ont pas \xe9t\xe9 saisies dans la situation. Leur valeur par d\xe9faut est utilis\xe9e."}),(0,s.jsx)(ge,{children:t.map((e=>(0,s.jsx)(be,{children:(0,s.jsx)(H,{dottedName:e})},e)))})]}):(0,s.jsx)("p",{children:"Il n'y a pas de donn\xe9es manquante."})]})}var Re=(e,t)=>e&&"replacements"in e&&e.replacements.some((e=>{let{replacedReference:n}=e;return n.dottedName===t}));function Oe(e){let{engine:t,dottedName:n,ruleIsNotDefined:r=!1}=e;const a=Array.from(t.context.referencesMaps.rulesThatUse.get(n)??[]).filter((e=>"$EVALUATION"!==e&&e in t.context.parsedRules&&!t.context.parsedRules[e].private&&!Re(t.context.parsedRules[e],n)));return(0,s.jsxs)("section",{children:[(0,s.jsx)("h4",{children:"R\xe8gles qui ont besoin de cette valeur"}),a.length?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("p",{children:["Les r\xe8gles suivantes ont besoin de la r\xe8gle courante pour \xeatre calcul\xe9es :",r&&(0,s.jsxs)(s.Fragment,{children:[" ","La r\xe8gle courante n'\xe9tant pas encore d\xe9finie, c'est sa valeur par d\xe9faut qui est utilis\xe9e pour d\xe9terminer la valeur de ces r\xe8gles."]})]}),(0,s.jsx)(ge,{children:a.map((e=>(0,s.jsx)(be,{children:(0,s.jsx)(H,{dottedName:e})},e)))})]}):(0,s.jsx)("p",{children:"Aucune r\xe8gle n'utilise cette valeur."})]})}function Ie(e){let{engine:t,dottedName:n,replacements:r}=e;const a=Array.from(t.context.referencesMaps.rulesThatUse.get(n)??[]).filter((e=>"$EVALUATION"!==e&&e in t.context.parsedRules&&!t.context.parsedRules[e].private&&Re(t.context.parsedRules[e],n)));return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("section",{children:[(0,s.jsx)("h4",{children:"Effets sur d'autres r\xe8gles"}),r.length?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("p",{children:"Une r\xe8gle peut avoir des effets sur d'autres r\xe8gles afin de modifier leur comportement."}),(0,s.jsx)(ge,{children:r.map((e=>(0,s.jsx)(be,{style:{marginBottom:"0.5rem"},children:(0,s.jsx)(me,{node:e})},e.replacedReference.dottedName)))})]}):(0,s.jsx)("p",{children:"Cette r\xe8gle ne modifie aucune autre r\xe8gle."})]}),(0,s.jsxs)("section",{children:[(0,s.jsx)("h4",{children:"R\xe8gles qui peuvent avoir un effet sur cette valeur"}),a.length?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("p",{children:"Les r\xe8gles suivantes peuvent remplacer la valeur de la r\xe8gle courante :"}),(0,s.jsx)(ge,{children:a.map((e=>(0,s.jsx)(be,{children:(0,s.jsx)(H,{dottedName:e})},e)))})]}):(0,s.jsx)("p",{children:"Aucune autre r\xe8gle n'a d'effet sur cette valeur."})]})]})}var Ce=o.zo.div``;function Pe(e){let{title:t,description:n}=e;const{Head:r}=(0,i.useContext)(V);return r?(0,s.jsxs)(r,{children:[(0,s.jsx)("title",{children:t}),(0,s.jsx)("meta",{property:"og:type",content:"article"}),(0,s.jsx)("meta",{property:"og:title",content:t}),n&&(0,s.jsx)("meta",{property:"og:description",content:n}),n&&(0,s.jsx)("meta",{name:"description",content:n})]}):null}function Ae(e){let{dottedName:t}=e;const n=S(),{title:r,rawNode:{description:i,question:o,"ic\xf4nes":l}}=n.context.parsedRules[t],u=l?r+" "+l:r;return(0,s.jsxs)("header",{children:[(0,s.jsx)(Pe,{title:u,description:i||o}),(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{id:"rules-nav-open-nav-button"}),a.utils.ruleParents(t).reverse().map((e=>(0,s.jsxs)("span",{children:[(0,s.jsx)(H,{dottedName:e,displayIcon:!0}),(0,s.jsx)("span",{"aria-hidden":!0,children:" \u203a "})]},e)))]}),(0,s.jsx)("h1",{children:(0,s.jsx)(H,{dottedName:t,displayIcon:!0})})]})}var _e=e=>{let{dottedName:t,mobileMenuPortalId:n,openNavButtonPortalId:r}=e;const o=S(),[u,d]=(0,i.useState)(!1),c=e=>Object.fromEntries([[e,!0],...a.utils.ruleParents(e).map((e=>[e,!0]))]),[p,m]=(0,i.useState)(c(t));(0,i.useEffect)((()=>{m((e=>({...e,...c(t)}))),d(!1)}),[t]);const h=o.getParsedRules(),f=(0,i.useCallback)((e=>{m((t=>t[e]?Object.fromEntries(Object.entries(t).map((t=>{let[n,r]=t;return n.startsWith(e)?[n,!1]:[n,r]}))):{...t,[e]:!t[e]}))}),[]),x=r&&document.getElementById(r)||document.getElementById("rules-nav-open-nav-button"),v=(0,s.jsxs)(Le,{$open:u,children:[(0,s.jsx)(Ke,{$open:u,onClick:()=>{d((e=>!e))}}),x&&l.createPortal((0,s.jsx)(Ue,{onClick:()=>d(!0),children:"Toutes les r\xe8gles"}),x),(0,s.jsx)(qe,{$open:u,children:(0,s.jsx)("ul",{children:Object.entries(h).sort(((e,t)=>{let[n]=e,[r]=t;return n.localeCompare(r)})).map((e=>{let[n,r]=e;const i=a.utils.ruleParent(n);if(n.split(" . ").length>1&&!p[i])return null;const o=n in p&&p[n];return(0,s.jsx)(De,{ruleDottedName:n,open:o,active:t===n,onClickDropdown:f},n)}))})})]}),g=window.matchMedia(`(max-width: ${Me.lg})`).matches,b=n?document.getElementById(n):null;return g&&b?l.createPortal(v,b):v},Te=e=>{let{ruleDottedName:t,open:n,active:r,onClickDropdown:a}=e;const o=S().getParsedRules(),l=Object.keys(o).reduce(((e,n)=>n.startsWith(t+" . ")&&n.split(" . ").length===t.split(" . ").length+1?e+1:e),0),u=(0,i.useRef)(null);return(0,i.useEffect)((()=>{u.current?.scrollIntoView({behavior:"auto",block:"center",inline:"start"})}),[]),(0,s.jsx)("li",{ref:r?u:void 0,style:{paddingLeft:16*(t.split(" . ").length-1)},className:(l>0?"dropdown ":"")+(r?"active ":""),children:(0,s.jsxs)("span",{className:"content",children:[l>0&&(0,s.jsx)(ze,{"aria-label":n?"Replier le sous-menu":"D\xe9plier le sous-menu","aria-expanded":n,onClick:()=>a(t),children:(0,s.jsx)(Fe,{$open:n})}),(0,s.jsx)(H,{dottedName:t,displayIcon:!0})]})},t)},De=(0,i.memo)(Te),Me={sm:"576px",md:"768px",lg:"992px",xl:"1200px"},Le=o.zo.div`
	z-index: 200;
	overflow: auto;
	position: sticky;
	top: 0;

	@media (min-width: ${Me.lg}) {
		max-width: 50%;
		flex-shrink: 0;
	}
`,Ke=o.zo.div`
	background: rgb(0 0 0 / 25%);
	position: fixed;
	top: 0;
	left: 0;
	bottom: 0;
	right: 0;
	z-index: 200;
	transition: ease-in-out 0.25s;
	transition-property: visibility, opacity;
	visibility: ${e=>{let{$open:t}=e;return t?"visible":"hidden"}};
	opacity: ${e=>{let{$open:t}=e;return t?"1":"0"}};

	@media (min-width: ${Me.lg}) {
		display: none;
	}
`,Ue=o.zo.button`
	margin: 0.25rem 0;
	margin-right: 0.5rem;
	background: none;
	border: 1px solid rgb(29, 66, 140);
	border-radius: 3px;
	color: rgb(29, 66, 140);
	padding: 0.5rem;
	display: inline-block;

	&:hover {
		background-color: rgb(219, 231, 255);
	}
	@media (min-width: ${Me.lg}) {
		display: none;
	}
`,qe=o.zo.nav`
	@media (min-width: ${Me.lg}) {
		flex-shrink: 0;
	}
	border-right: 1px solid #e6e6e6;
	overflow: auto;
	max-height: calc(100vh - 2rem);
	position: sticky;
	top: 0;
	@media (max-width: ${Me.lg}) {
		position: fixed;
		top: 0;
		left: 0;
		padding-top: 1rem;
		bottom: 0;
		z-index: 200;
		max-height: initial;
		background: white;
		max-width: 80vw;
		height: 100%;

		transition: all ease-in-out 0.25s;
		${e=>{let{$open:t}=e;return t?"":"transform: translateX(-100%);"}}
	}

	ul {
		flex-wrap: nowrap;
		margin: 0;

		padding: 0;
		list-style: none;
		li {
			margin-bottom: 3px;
			max-width: 350px;
			.content {
				border-radius: 3px;
				padding: 3px 1rem;
				display: flex;
				width: fit-content;
				align-items: center;
				flex-direction: row;
				flex-wrap: nowrap;
			}

			&.active .content {
				background-color: #e6e6e6;
			}
			&:not(.active) a {
				font-weight: normal;
			}
			&:not(.dropdown) .content:before {
				content: ' ';
				display: inline-block;
				background-color: #b3b3b3;
				min-width: 0.5rem;
				min-height: 0.5rem;
				border-radius: 0.5rem;
				margin-left: 0.5rem;
				margin-right: 1.25rem;
				pointer-events: none;
			}
		}
	}
`,ze=o.zo.button`
	margin-right: 0.75rem;
	flex-shrink: 0;
	background: none;
	border: 1px solid #b3b3b3;
	border-radius: 2rem;
	width: 1.5rem;
	height: 1.5rem;
	color: #999;
	padding: 0;
	display: inline-block;
`,Fe=(0,o.zo)(u)`
	width: 100%;
	transition: transform 0.1s;
	height: 100%;
	transform: rotate(${e=>{let{$open:t}=e;return t?"0deg":"-90deg"}});
`;function Be(e){let{documentationPath:t,rulePath:n,engine:r,renderers:o,language:l,apiDocumentationUrl:u,apiEvaluateUrl:d,npmPackage:c,mobileMenuPortalId:p,openNavButtonPortalId:m,showDevSection:h=!0}=e;const f="undefined"!=typeof window&&new URLSearchParams(window.location.search).get("currentEngineId"),x=(0,i.useRef)(o),[v,g]=(0,i.useState)(w(o));return(0,i.useEffect)((()=>{x.current!==o&&(x.current=o,g(w(o)))}),[o]),(0,s.jsx)(E.Provider,{value:r,children:(0,s.jsx)($.Provider,{value:t,children:(0,s.jsx)(V.Provider,{value:w(o),children:(0,s.jsx)(We,{dottedName:a.utils.decodeRuleName(n),subEngineId:f?parseInt(f):void 0,language:l,apiDocumentationUrl:u,apiEvaluateUrl:d,npmPackage:c,mobileMenuPortalId:p,openNavButtonPortalId:m,showDevSection:h})})})})}function We(e){let{dottedName:t,language:n,subEngineId:r,apiDocumentationUrl:o,apiEvaluateUrl:l,npmPackage:u,mobileMenuPortalId:d,openNavButtonPortalId:c,showDevSection:p}=e;const m=S(),{References:h,Text:f}=(0,i.useContext)(V),x=r&&m.subEngines.length>=r,v=x?m.subEngines[r]:m;if(!(t in v.context.parsedRules))return(0,s.jsx)("p",{children:"Cette r\xe8gle est introuvable dans la base"});const g=v.evaluateNode(v.context.parsedRules[t]),{description:b,question:y}=g.rawNode,{valeur:j,nullableParent:N,ruleDisabledByItsParent:w}=g.explanation,$=function(e,t){const n=[...t.traversedVariables,t.dottedName].map((t=>{const n=e.context.parsedRules[`${t} . $SITUATION`]?.rawNode.valeur;return[t,n]})).filter((e=>{let[t,n]=e;return n&&!("constant"===n.nodeKind&&void 0===n.nodeValue)})).reduce(((e,t)=>{let[n,r]=t;return{[n]:"object"==typeof r&&r&&"rawNode"in r?r.rawNode:r,...e}}),{});return n}(v,g),R=h?.({references:g.rawNode.r\u00e9f\u00e9rences,dottedName:g.dottedName});return(0,s.jsx)(E.Provider,{value:v,children:(0,s.jsxs)(Je,{id:"documentation-rule-root",children:[(0,s.jsx)(_e,{dottedName:t,mobileMenuPortalId:d,openNavButtonPortalId:c}),(0,s.jsx)(He,{children:(0,s.jsxs)(k.Provider,{value:t,children:[(0,s.jsx)(Ae,{dottedName:t}),(0,s.jsx)("section",{children:(0,s.jsx)(f,{children:b||y||""})}),(0,s.jsxs)("p",{style:{fontSize:"1.25rem",lineHeight:"2rem"},children:["Valeur : ",(0,a.Bw)(g,{language:n}),void 0===g.nodeValue&&g.unit&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("br",{}),"Unit\xe9 : ",(0,a.gL)(g.unit)]})]}),w&&(0,s.jsx)(s.Fragment,{children:(0,s.jsxs)("blockquote",{children:["Cette r\xe8gle est ",(0,s.jsx)("strong",{children:"non applicable"})," car elle appartient \xe0 l'espace de nom :"," ",(0,s.jsx)(me,{node:N})]})}),x&&(0,s.jsxs)("div",{style:{display:"flex",alignItems:"baseline",flexWrap:"wrap",margin:"1rem 0",paddingTop:"0.4rem",paddingBottom:"0.4rem"},children:[(0,s.jsxs)("div",{children:["Les valeurs affich\xe9es sont calcul\xe9es avec la situation sp\xe9cifique du ",(0,s.jsx)("strong",{children:"m\xe9canisme recalcul"})]}),(0,s.jsx)("div",{style:{flex:1}}),(0,s.jsx)("div",{children:(0,s.jsx)(H,{dottedName:t,useSubEngine:!1,children:"Retourner \xe0 la version de base"})})]}),(0,s.jsx)("h2",{children:"Comment cette donn\xe9e est-elle calcul\xe9e ?"}),(0,s.jsx)("div",{id:"documentation-rule-explanation",children:(0,s.jsx)(me,{node:j})}),g.rawNode.note&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("h3",{children:"Note"}),(0,s.jsx)("div",{children:(0,s.jsx)(f,{children:g.rawNode.note})})]}),R&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("h3",{children:"R\xe9f\xe9rences"}),R]}),(0,s.jsx)("br",{}),p&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("h3",{children:"Informations techniques"}),(0,s.jsx)(f,{children:"Si vous \xeates d\xe9veloppeur/euse vous trouverez ci-dessous des informations techniques utiles pour l'int\xe9gration de cette r\xe8gle dans votre application."}),(0,s.jsx)(ye,{engine:v,situation:$,dottedName:t,rule:g,apiDocumentationUrl:o,apiEvaluateUrl:l,npmPackage:u})]})]})})]})})}var Je=o.zo.div`
	display: flex;
	flex-wrap: nowrap;
	align-items: flex-start;
	@media (max-width: ${Me.lg}) {
		flex-direction: column;
	}
`,He=o.zo.article`
	flex-shrink: 1;
	max-width: 100%;
	@media (min-width: ${Me.lg}) {
		min-width: 0;
		padding-left: 1rem;
		border-left: 1px solid #e6e6e6;
		margin-left: -1px;
	}
`;var Ze=n(2719),Ge=n(1516),Xe=n(3620),Ye=n(4289),Qe=n(600),et=n(9277);class tt{messages=[];warn(e){this.messages.push(e)}error(e){this.messages.push(e)}log(e){this.messages.push(e)}toJSX(){return this.messages.map((e=>i.createElement("div",{style:{background:"lightyellow",padding:20,borderRadius:5},key:e},(0,Qe.h)(e))))}}function nt(e){let{onClickShare:t,rules:n,defaultTarget:s="",onTargetChange:o,baseUrl:l,showDevSection:u}=e;const d=(0,i.useMemo)((()=>new tt),[n]),c=(0,i.useMemo)((()=>new a.ZP((0,et.Qc)(n),{logger:d})),[n,d]),p=(0,i.useMemo)((()=>Object.keys(c.getParsedRules())),[c]),m=(0,i.useMemo)((()=>function(e){let{engine:t,documentationPath:n}=e;const r=t.context.parsedRules;return Object.fromEntries(Object.keys(r).map((e=>[n+"/"+a.utils.encodeRuleName(e),e])))}({engine:c,documentationPath:""})),[c]),h=(0,i.useMemo)((()=>(0,Ze.Z)(m)),[m]),{search:f,pathname:x}=(0,Xe.TH)(),v=new URLSearchParams(f??""),g=(0,Xe.k6)(),[b,y]=(0,i.useState)(v.get("rule")||s),j=(0,i.useCallback)((e=>{o?.(e),y(e)}),[o]);return(0,i.useEffect)((()=>{p.includes(b)||j((0,Ge.Z)(p)??"")}),[b]),(0,i.useEffect)((()=>{v.get("rule")!==b&&v.set("rule",b)}),[v,b]),(0,i.useEffect)((()=>{if(null==l)return;const e=l+"/"+a.utils.encodeRuleName(b);x!==e&&g.replace({...g.location,pathname:e})}),[l,b,x,g]),i.createElement("div",{style:{padding:"1rem"}},d.toJSX(),i.createElement(Qe.Z,null,i.createElement(Be,{language:"fr",rulePath:h[b]?.replace(/^\//,"")||"",engine:c,documentationPath:"",showDevSection:u,renderers:{Link:e=>{let{to:t,children:n}=e;return i.createElement(Ye.rU,{to:t,onClick:e=>{e.preventDefault(),e.stopPropagation(),j(m[t])}},n)},Head:r.Z}})),t&&i.createElement("button",{style:{margin:"1rem auto",display:"block"},onClick:t},"\ud83d\udd17 Copier le lien de la page"))}},600:(e,t,n)=>{n.d(t,{Z:()=>a,h:()=>s});var r=n(7378);class a extends r.Component{state={error:!1};static getDerivedStateFromError(e){return console.error(e),{error:{message:e.message,name:e.name}}}render(){return this.state.error?r.createElement("div",{style:{background:"lightyellow",padding:"20px",borderRadius:"5px"}},r.createElement("strong",null,this.state.error.name),r.createElement("br",null),s(this.state.error.message),r.createElement("br",null),r.createElement("br",null),r.createElement("a",{onClick:()=>window.location.reload()},"Rafraichir")):this.props.children}}const i=/(\r\n|\r|\n)/g;function s(e){return"string"!=typeof e?e:e.split(i).map((function(e,t){return e.match(i)?r.createElement("br",{key:t}):e}))}},6364:(e,t,n)=>{n.r(t),n.d(t,{default:()=>c});var r=n(5773),a=n(6499);const i={playgroundContainer:"playgroundContainer_hdQm",playgroundHeader:"playgroundHeader_vDzg",playgroundEditor:"playgroundEditor_YjED",playgroundPreview:"playgroundPreview_Prez"};var s=n(7378),o=n(8431),l=n(8418),u=n(600),d=n(2494);function c(e){let{language:t,defaultTarget:n,onTargetChange:c,onChange:p,children:m,...h}=e;const f=(0,a.p)();return s.createElement("div",{className:i.playgroundContainer},s.createElement("div",{className:i.playgroundHeader},"Editeur live"),s.createElement(o.ML,(0,r.Z)({},h,{code:m,theme:f,language:t,disabled:!1,className:i.playgroundEditor+" "+d.Z.editor,onChange:p})),s.createElement(u.Z,{key:m},s.createElement(l.Z,{rules:m,defaultTarget:n,onTargetChange:c,showDevSection:!1}),s.createElement("div",{style:{paddingBottom:"1rem"}})))}},3370:(e,t,n)=>{n.d(t,{Bw:()=>Ze,Tt:()=>Je,ZP:()=>In,fk:()=>j,gL:()=>ue,n2:()=>ae,utils:()=>Ge});var r=Object.create,a=Object.defineProperty,i=Object.getOwnPropertyDescriptor,s=Object.getOwnPropertyNames,o=Object.getPrototypeOf,l=Object.prototype.hasOwnProperty,u=(e,t)=>function(){return t||(0,e[s(e)[0]])((t={exports:{}}).exports,t),t.exports},d=(e,t,n)=>(n=null!=e?r(o(e)):{},((e,t,n,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let o of s(t))l.call(e,o)||o===n||a(e,o,{get:()=>t[o],enumerable:!(r=i(t,o))||r.enumerable});return e})(!t&&e&&e.__esModule?n:a(n,"default",{value:e,enumerable:!0}),e)),c=u({"../../node_modules/nearley/lib/nearley.js"(e,t){var n,r;n=e,r=function(){function e(t,n,r){return this.id=++e.highestId,this.name=t,this.symbols=n,this.postprocess=r,this}function t(e,t,n,r){this.rule=e,this.dot=t,this.reference=n,this.data=[],this.wantedBy=r,this.isComplete=this.dot===e.symbols.length}function n(e,t){this.grammar=e,this.index=t,this.states=[],this.wants={},this.scannable=[],this.completed={}}function r(e,t){this.rules=e,this.start=t||this.rules[0].name;var n=this.byName={};this.rules.forEach((function(e){n.hasOwnProperty(e.name)||(n[e.name]=[]),n[e.name].push(e)}))}function a(){this.reset("")}function i(e,t,i){if(e instanceof r){var s=e;i=t}else s=r.fromCompiled(e,t);for(var o in this.grammar=s,this.options={keepHistory:!1,lexer:s.lexer||new a},i||{})this.options[o]=i[o];this.lexer=this.options.lexer,this.lexerState=void 0;var l=new n(s,0);this.table=[l],l.wants[s.start]=[],l.predict(s.start),l.process(),this.current=0}function s(e){var t=typeof e;if("string"===t)return e;if("object"===t){if(e.literal)return JSON.stringify(e.literal);if(e instanceof RegExp)return e.toString();if(e.type)return"%"+e.type;if(e.test)return"<"+String(e.test)+">";throw new Error("Unknown symbol type: "+e)}}return e.highestId=0,e.prototype.toString=function(e){var t=void 0===e?this.symbols.map(s).join(" "):this.symbols.slice(0,e).map(s).join(" ")+" \u25cf "+this.symbols.slice(e).map(s).join(" ");return this.name+" \u2192 "+t},t.prototype.toString=function(){return"{"+this.rule.toString(this.dot)+"}, from: "+(this.reference||0)},t.prototype.nextState=function(e){var n=new t(this.rule,this.dot+1,this.reference,this.wantedBy);return n.left=this,n.right=e,n.isComplete&&(n.data=n.build(),n.right=void 0),n},t.prototype.build=function(){var e=[],t=this;do{e.push(t.right.data),t=t.left}while(t.left);return e.reverse(),e},t.prototype.finish=function(){this.rule.postprocess&&(this.data=this.rule.postprocess(this.data,this.reference,i.fail))},n.prototype.process=function(e){for(var t=this.states,n=this.wants,r=this.completed,a=0;a<t.length;a++){var s=t[a];if(s.isComplete){if(s.finish(),s.data!==i.fail){for(var o=s.wantedBy,l=o.length;l--;){var u=o[l];this.complete(u,s)}if(s.reference===this.index){var d=s.rule.name;(this.completed[d]=this.completed[d]||[]).push(s)}}}else{if("string"!=typeof(d=s.rule.symbols[s.dot])){this.scannable.push(s);continue}if(n[d]){if(n[d].push(s),r.hasOwnProperty(d)){var c=r[d];for(l=0;l<c.length;l++){var p=c[l];this.complete(s,p)}}}else n[d]=[s],this.predict(d)}}},n.prototype.predict=function(e){for(var n=this.grammar.byName[e]||[],r=0;r<n.length;r++){var a=n[r],i=this.wants[e],s=new t(a,0,this.index,i);this.states.push(s)}},n.prototype.complete=function(e,t){var n=e.nextState(t);this.states.push(n)},r.fromCompiled=function(t,n){var a=t.Lexer;t.ParserStart&&(n=t.ParserStart,t=t.ParserRules);var i=new r(t=t.map((function(t){return new e(t.name,t.symbols,t.postprocess)})),n);return i.lexer=a,i},a.prototype.reset=function(e,t){this.buffer=e,this.index=0,this.line=t?t.line:1,this.lastLineBreak=t?-t.col:0},a.prototype.next=function(){if(this.index<this.buffer.length){var e=this.buffer[this.index++];return"\n"===e&&(this.line+=1,this.lastLineBreak=this.index),{value:e}}},a.prototype.save=function(){return{line:this.line,col:this.index-this.lastLineBreak}},a.prototype.formatError=function(e,t){var n=this.buffer;if("string"==typeof n){var r=n.split("\n").slice(Math.max(0,this.line-5),this.line),a=n.indexOf("\n",this.index);-1===a&&(a=n.length);var i=this.index-this.lastLineBreak,s=String(this.line).length;return t+=" at line "+this.line+" col "+i+":\n\n",t+=r.map((function(e,t){return o(this.line-r.length+t+1,s)+" "+e}),this).join("\n"),t+="\n"+o("",s+i)+"^\n"}return t+" at index "+(this.index-1);function o(e,t){var n=String(e);return Array(t-n.length+1).join(" ")+n}},i.fail={},i.prototype.feed=function(e){var t,r=this.lexer;for(r.reset(e,this.lexerState);;){try{if(!(t=r.next()))break}catch(x){var i=new n(this.grammar,this.current+1);throw this.table.push(i),(l=new Error(this.reportLexerError(x))).offset=this.current,l.token=x.token,l}var s=this.table[this.current];this.options.keepHistory||delete this.table[this.current-1];var o=this.current+1;i=new n(this.grammar,o),this.table.push(i);for(var l,u=void 0!==t.text?t.text:t.value,d=r.constructor===a?t.value:t,c=s.scannable,p=c.length;p--;){var m=c[p],h=m.rule.symbols[m.dot];if(h.test?h.test(d):h.type?h.type===t.type:h.literal===u){var f=m.nextState({data:d,token:t,isToken:!0,reference:o-1});i.states.push(f)}}if(i.process(),0===i.states.length)throw(l=new Error(this.reportError(t))).offset=this.current,l.token=t,l;this.options.keepHistory&&(s.lexerState=r.save()),this.current++}return s&&(this.lexerState=r.save()),this.results=this.finish(),this},i.prototype.reportLexerError=function(e){var t,n,r=e.token;return r?(t="input "+JSON.stringify(r.text[0])+" (lexer error)",n=this.lexer.formatError(r,"Syntax error")):(t="input (lexer error)",n=e.message),this.reportErrorCommon(n,t)},i.prototype.reportError=function(e){var t=(e.type?e.type+" token: ":"")+JSON.stringify(void 0!==e.value?e.value:e),n=this.lexer.formatError(e,"Syntax error");return this.reportErrorCommon(n,t)},i.prototype.reportErrorCommon=function(e,t){var n=[];n.push(e);var r=this.table.length-2,a=this.table[r],i=a.states.filter((function(e){var t=e.rule.symbols[e.dot];return t&&"string"!=typeof t}));return 0===i.length?(n.push("Unexpected "+t+". I did not expect any more input. Here is the state of my parse table:\n"),this.displayStateStack(a.states,n)):(n.push("Unexpected "+t+". Instead, I was expecting to see one of the following:\n"),i.map((function(e){return this.buildFirstStateStack(e,[])||[e]}),this).forEach((function(e){var t=e[0],r=t.rule.symbols[t.dot],a=this.getSymbolDisplay(r);n.push("A "+a+" based on:"),this.displayStateStack(e,n)}),this)),n.push(""),n.join("\n")},i.prototype.displayStateStack=function(e,t){for(var n,r=0,a=0;a<e.length;a++){var i=e[a],s=i.rule.toString(i.dot);s===n?r++:(r>0&&t.push("    ^ "+r+" more lines identical to this"),r=0,t.push("    "+s)),n=s}},i.prototype.getSymbolDisplay=function(e){return function(e){var t=typeof e;if("string"===t)return e;if("object"===t){if(e.literal)return JSON.stringify(e.literal);if(e instanceof RegExp)return"character matching "+e;if(e.type)return e.type+" token";if(e.test)return"token matching "+String(e.test);throw new Error("Unknown symbol type: "+e)}}(e)},i.prototype.buildFirstStateStack=function(e,t){if(-1!==t.indexOf(e))return null;if(0===e.wantedBy.length)return[e];var n=e.wantedBy[0],r=[e].concat(t),a=this.buildFirstStateStack(n,r);return null===a?null:[e].concat(a)},i.prototype.save=function(){var e=this.table[this.current];return e.lexerState=this.lexerState,e},i.prototype.restore=function(e){var t=e.index;this.current=t,this.table[t]=e,this.table.splice(t+1),this.lexerState=e.lexerState,this.results=this.finish()},i.prototype.rewind=function(e){if(!this.options.keepHistory)throw new Error("set option `keepHistory` to enable rewinding");this.restore(this.table[e])},i.prototype.finish=function(){var e=[],t=this.grammar.start;return this.table[this.table.length-1].states.forEach((function(n){n.rule.name===t&&n.dot===n.rule.symbols.length&&0===n.reference&&n.data!==i.fail&&e.push(n)})),e.map((function(e){return e.data}))},{Parser:i,Grammar:r,Rule:e}},"object"==typeof t&&t.exports?t.exports=r():n.nearley=r()}}),p=u({"../../node_modules/moo/moo.js"(e,t){var n,r;n=e,r=function(){var e=Object.prototype.hasOwnProperty,t=Object.prototype.toString,n="boolean"==typeof(new RegExp).sticky;function r(e){return e&&"[object RegExp]"===t.call(e)}function a(e){return e&&"object"==typeof e&&!r(e)&&!Array.isArray(e)}function i(e){return"("+e+")"}function s(e){return e.length?"(?:"+e.map((function(e){return"(?:"+e+")"})).join("|")+")":"(?!)"}function o(e){if("string"==typeof e)return"(?:"+e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+")";if(r(e)){if(e.ignoreCase)throw new Error("RegExp /i flag not allowed");if(e.global)throw new Error("RegExp /g flag is implied");if(e.sticky)throw new Error("RegExp /y flag is implied");if(e.multiline)throw new Error("RegExp /m flag is implied");return e.source}throw new Error("Not a pattern: "+e)}function l(e,t){return e.length>t?e:Array(t-e.length+1).join(" ")+e}function u(t,n){if(a(n)||(n={match:n}),n.include)throw new Error("Matching rules cannot also include states");var i={defaultType:t,lineBreaks:!!n.error||!!n.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var s in n)e.call(n,s)&&(i[s]=n[s]);if("string"==typeof i.type&&t!==i.type)throw new Error("Type transform cannot be a string (type '"+i.type+"' for token '"+t+"')");var o=i.match;return i.match=Array.isArray(o)?o:o?[o]:[],i.match.sort((function(e,t){return r(e)&&r(t)?0:r(t)?-1:r(e)?1:t.length-e.length})),i}function d(e){return Array.isArray(e)?function(e){for(var t=[],n=0;n<e.length;n++){var r=e[n];if(r.include)for(var a=[].concat(r.include),i=0;i<a.length;i++)t.push({include:a[i]});else{if(!r.type)throw new Error("Rule has no type: "+JSON.stringify(r));t.push(u(r.type,r))}}return t}(e):function(e){for(var t=Object.getOwnPropertyNames(e),n=[],r=0;r<t.length;r++){var i=t[r],s=e[i],o=[].concat(s);if("include"!==i){var l=[];o.forEach((function(e){a(e)?(l.length&&n.push(u(i,l)),n.push(u(i,e)),l=[]):l.push(e)})),l.length&&n.push(u(i,l))}else for(var d=0;d<o.length;d++)n.push({include:o[d]})}return n}(e)}var c=u("error",{lineBreaks:!0,shouldThrow:!0});function p(e,t){for(var a=null,l=Object.create(null),u=!0,d=null,p=[],m=[],h=0;h<e.length;h++)e[h].fallback&&(u=!1);for(h=0;h<e.length;h++){var f=e[h];if(f.include)throw new Error("Inheritance is not allowed in stateless lexers");if(f.error||f.fallback){if(a)throw!f.fallback==!a.fallback?new Error("Multiple "+(f.fallback?"fallback":"error")+" rules not allowed (for token '"+f.defaultType+"')"):new Error("fallback and error are mutually exclusive (for token '"+f.defaultType+"')");a=f}var x=f.match.slice();if(u)for(;x.length&&"string"==typeof x[0]&&1===x[0].length;)l[x.shift().charCodeAt(0)]=f;if(f.pop||f.push||f.next){if(!t)throw new Error("State-switching options are not allowed in stateless lexers (for token '"+f.defaultType+"')");if(f.fallback)throw new Error("State-switching options are not allowed on fallback tokens (for token '"+f.defaultType+"')")}if(0!==x.length){u=!1,p.push(f);for(var v=0;v<x.length;v++){var g=x[v];if(r(g))if(null===d)d=g.unicode;else if(d!==g.unicode&&!1===f.fallback)throw new Error("If one rule is /u then all must be")}var b=s(x.map(o)),y=new RegExp(b);if(y.test(""))throw new Error("RegExp matches empty string: "+y);if(new RegExp("|"+b).exec("").length-1>0)throw new Error("RegExp has capture groups: "+y+"\nUse (?: \u2026 ) instead");if(!f.lineBreaks&&y.test("\n"))throw new Error("Rule should declare lineBreaks: "+y);m.push(i(b))}}var j=a&&a.fallback,N=n&&!j?"ym":"gm",w=n||j?"":"|";return!0===d&&(N+="u"),{regexp:new RegExp(s(m)+w,N),groups:p,fast:l,error:a||c}}function m(e,t,n){var r=e&&(e.push||e.next);if(r&&!n[r])throw new Error("Missing state '"+r+"' (in token '"+e.defaultType+"' of state '"+t+"')");if(e&&e.pop&&1!=+e.pop)throw new Error("pop must be 1 (in token '"+e.defaultType+"' of state '"+t+"')")}var h=function(e,t){this.startState=t,this.states=e,this.buffer="",this.stack=[],this.reset()};h.prototype.reset=function(e,t){return this.buffer=e||"",this.index=0,this.line=t?t.line:1,this.col=t?t.col:1,this.queuedToken=t?t.queuedToken:null,this.queuedText=t?t.queuedText:"",this.queuedThrow=t?t.queuedThrow:null,this.setState(t?t.state:this.startState),this.stack=t&&t.stack?t.stack.slice():[],this},h.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedText:this.queuedText,queuedThrow:this.queuedThrow}},h.prototype.setState=function(e){if(e&&this.state!==e){this.state=e;var t=this.states[e];this.groups=t.groups,this.error=t.error,this.re=t.regexp,this.fast=t.fast}},h.prototype.popState=function(){this.setState(this.stack.pop())},h.prototype.pushState=function(e){this.stack.push(this.state),this.setState(e)};var f=n?function(e,t){return e.exec(t)}:function(e,t){var n=e.exec(t);return 0===n[0].length?null:n};function x(){return this.value}if(h.prototype._getGroup=function(e){for(var t=this.groups.length,n=0;n<t;n++)if(void 0!==e[n+1])return this.groups[n];throw new Error("Cannot find token type for matched text")},h.prototype.next=function(){var e=this.index;if(this.queuedGroup){var t=this._token(this.queuedGroup,this.queuedText,e);return this.queuedGroup=null,this.queuedText="",t}var n=this.buffer;if(e!==n.length){if(s=this.fast[n.charCodeAt(e)])return this._token(s,n.charAt(e),e);var r=this.re;r.lastIndex=e;var a=f(r,n),i=this.error;if(null==a)return this._token(i,n.slice(e,n.length),e);var s=this._getGroup(a),o=a[0];return i.fallback&&a.index!==e?(this.queuedGroup=s,this.queuedText=o,this._token(i,n.slice(e,a.index),e)):this._token(s,o,e)}},h.prototype._token=function(e,t,n){var r=0;if(e.lineBreaks){var a=/\n/g,i=1;if("\n"===t)r=1;else for(;a.exec(t);)r++,i=a.lastIndex}var s={type:"function"==typeof e.type&&e.type(t)||e.defaultType,value:"function"==typeof e.value?e.value(t):t,text:t,toString:x,offset:n,lineBreaks:r,line:this.line,col:this.col},o=t.length;if(this.index+=o,this.line+=r,0!==r?this.col=o-i+1:this.col+=o,e.shouldThrow)throw new Error(this.formatError(s,"invalid syntax"));return e.pop?this.popState():e.push?this.pushState(e.push):e.next&&this.setState(e.next),s},"undefined"!=typeof Symbol&&Symbol.iterator){var v=function(e){this.lexer=e};v.prototype.next=function(){var e=this.lexer.next();return{value:e,done:!e}},v.prototype[Symbol.iterator]=function(){return this},h.prototype[Symbol.iterator]=function(){return new v(this)}}return h.prototype.formatError=function(e,t){if(null==e){var n=this.buffer.slice(this.index);e={text:n,offset:this.index,lineBreaks:-1===n.indexOf("\n")?0:1,line:this.line,col:this.col}}var r=Math.max(e.line-2,1),a=e.line+2,i=String(a).length,s=function(e,t){for(var n=e.length,r=0;;){var a=e.lastIndexOf("\n",n-1);if(-1===a)break;if(n=a,++r===t)break;if(0===n)break}var i=r<t?0:n+1;return e.substring(i).split("\n")}(this.buffer,this.line-e.line+2+1).slice(0,5),o=[];o.push(t+" at line "+e.line+" col "+e.col+":"),o.push("");for(var u=0;u<s.length;u++){var d=s[u],c=r+u;o.push(l(String(c),i)+"  "+d),c===e.line&&o.push(l("",i+e.col+1)+"^")}return o.join("\n")},h.prototype.clone=function(){return new h(this.states,this.state)},h.prototype.has=function(e){return!0},{compile:function(e){var t=p(d(e));return new h({start:t},"start")},states:function(e,t){var n=e.$all?d(e.$all):[];delete e.$all;var r=Object.getOwnPropertyNames(e);t||(t=r[0]);for(var a=Object.create(null),i=0;i<r.length;i++)a[b=r[i]]=d(e[b]).concat(n);for(i=0;i<r.length;i++)for(var s=a[b=r[i]],o=Object.create(null),l=0;l<s.length;l++){var u=s[l];if(u.include){var c=[l,1];if(u.include!==b&&!o[u.include]){o[u.include]=!0;var f=a[u.include];if(!f)throw new Error("Cannot include nonexistent state '"+u.include+"' (in state '"+b+"')");for(var x=0;x<f.length;x++){var v=f[x];-1===s.indexOf(v)&&c.push(v)}}s.splice.apply(s,c),l--}}var g=Object.create(null);for(i=0;i<r.length;i++){var b;g[b=r[i]]=p(a[b],!0)}for(i=0;i<r.length;i++){var y=r[i],j=g[y],N=j.groups;for(l=0;l<N.length;l++)m(N[l],y,g);var w=Object.getOwnPropertyNames(j.fast);for(l=0;l<w.length;l++)m(j.fast[w[l]],y,g)}return new h(g,t)},error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:function(e){for(var t="undefined"!=typeof Map,n=t?new Map:Object.create(null),r=Object.getOwnPropertyNames(e),a=0;a<r.length;a++){var i=r[a],s=e[i];(Array.isArray(s)?s:[s]).forEach((function(e){if("string"!=typeof e)throw new Error("keyword must be string (in keyword '"+i+"')");t?n.set(e,i):n[e]=i}))}return function(e){return t?n.get(e):n[e]}}}},"function"==typeof define&&define.amd?define([],r):"object"==typeof t&&t.exports?t.exports=r():n.moo=r()}}),m=class extends Error{name;info;constructor(e,t,n,r){super(h(e,t,n,r)),this.name=e,this.info=n}},h=(e,t,n,r)=>{const a=/error/i.test(e);return`\n[ ${{SyntaxError:"Erreur syntaxique",EvaluationError:"Erreur d'\xe9valuation",UnknownRule:"R\xe8gle inconnue",PrivateRule:"R\xe8gle priv\xe9e"}[e]??e} ]`+(n&&"dottedName"in n&&n.dottedName?.length?`\n\u27a1\ufe0f  Dans la r\xe8gle "${n.dottedName}"`:"")+`\n${a?"\u2716\ufe0f":"\u26a0\ufe0f"}  ${t}`+(r?"\n"+(a?"    ":"\u2139\ufe0f  ")+r.message:"")},f=class extends m{constructor(e){super("InternalError",`\nErreur interne du moteur.\n\nCette erreur est le signe d'un bug dans publicodes. Pour nous aider \xe0 le r\xe9soudre, vous pouvez copier ce texte dans un nouveau ticket : https://github.com/betagouv/mon-entreprise/issues/new.\n\npayload:\n${JSON.stringify(e,null,2)}\n`,e)}},x=class extends f{constructor(e){super(e)}};function v(e,t,n,r){e.warn(h("Avertissement",t,n,r))}function g(e,t){e.warn(h("Avertissement","Cette r\xe8gle est taggu\xe9e comme experimentale. \n\nCela veut dire qu'elle peut \xeatre modifi\xe9e, renomm\xe9e, ou supprim\xe9e sans qu'il n'y ait de changement de version majeure dans l'API.\n",{dottedName:t}))}function b(e,t,n){e.has(t)?e.get(t).add(n):e.set(t,new Set([n]))}var y=e=>{const t={};for(const n in e)t[n]=e[n];return t};function j(e,t){return void 0===t&&(t=!0),function n(r){const a=e(r,n);return!1===a?r:void 0===a?w(n,r):t?a:w(n,a)}}function N(e){function t(r){switch(e(r,t)){case"continue":return void w(n,r);case"stop":return}}const n=e=>(t(e),e);return t}var w=(e,t)=>{switch((t=V(e,t)).nodeKind){case"rule":return $(e,t);case"reference":case"constant":return t;case"arrondi":return A(e,t);case"simplifier unit\xe9":case"variable manquante":case"est non applicable":case"est non d\xe9fini":return E(e,t);case"bar\xe8me":case"taux progressif":case"grille":return R(e,t);case"une possibilit\xe9":return O(e,t);case"dur\xe9e":return C(e,t);case"r\xe9soudre r\xe9f\xe9rence circulaire":return _(e,t);case"inversion":return P(e,t);case"operation":return I(e,t);case"recalcul":return D(e,t);case"unit\xe9":return M(e,t);case"variations":return L(e,t);case"replacementRule":return k(e,t);case"texte":return T(e,t);case"condition":return K(e,t);default:throw new x(t)}},V=(e,t)=>{if(!("sourceMap"in t)||!t.sourceMap||!t.sourceMap.args)return t;const n=t.sourceMap,r={};for(const a in n.args){const t=n.args[a];r[a]=Array.isArray(t)?t.map((t=>e(t))):e(t)}return{...t,sourceMap:{...n,args:r}}},$=(e,t)=>{const n=y(t);n.suggestions={};for(const r in t.suggestions)n.suggestions[r]=e(t.suggestions[r]);return n.replacements=t.replacements.map(e),n.explanation={ruleDisabledByItsParent:t.explanation.ruleDisabledByItsParent,nullableParent:t.explanation.nullableParent?e(t.explanation.nullableParent):void 0,parents:t.explanation.parents.map(e),valeur:e(t.explanation.valeur)},n},k=(e,t)=>({...t,definitionRule:e(t.definitionRule),replacedReference:e(t.replacedReference),replacementNode:e(t.replacementNode),whiteListedNames:t.whiteListedNames.map(e),blackListedNames:t.blackListedNames.map(e)}),E=(e,t)=>({...t,explanation:e(t.explanation)});function S(e,t){return t.map((t=>({...t,...t.plafond&&{plafond:e(t.plafond)},..."montant"in t&&{montant:e(t.montant)},..."taux"in t&&{taux:e(t.taux)}})))}var R=(e,t)=>({...t,explanation:{assiette:e(t.explanation.assiette),multiplicateur:e(t.explanation.multiplicateur),tranches:S(e,t.explanation.tranches)}}),O=(e,t)=>({...t,explanation:t.explanation.map(e)}),I=(e,t)=>{const n=y(t);return n.explanation=[e(t.explanation[0]),e(t.explanation[1])],n},C=(e,t)=>({...t,explanation:{depuis:e(t.explanation.depuis),"jusqu'\xe0":e(t.explanation["jusqu'\xe0"])}}),P=(e,t)=>({...t,explanation:{...t.explanation,inversionCandidates:t.explanation.inversionCandidates.map(e)}}),A=(e,t)=>({...t,explanation:{valeur:e(t.explanation.valeur),arrondi:e(t.explanation.arrondi)}}),_=(e,t)=>({...t,explanation:{...t.explanation,valeur:e(t.explanation.valeur)}}),T=(e,t)=>({...t,explanation:t.explanation.map((t=>"string"==typeof t?t:e(t)))}),D=(e,t)=>({...t,explanation:{...t.explanation,amendedSituation:t.explanation.amendedSituation.map((t=>{let[n,r]=t;return[e(n),e(r)]})),recalcul:t.explanation.recalculNode&&e(t.explanation.recalculNode)}}),M=(e,t)=>{const n=y(t);return n.explanation=e(t.explanation),n},L=(e,t)=>({...t,explanation:t.explanation.map((t=>{let{condition:n,consequence:r}=t;return{condition:e(n),consequence:r&&e(r)}}))}),K=(e,t)=>{const n=y(t);return n.explanation={si:e(t.explanation.si),alors:e(t.explanation.alors),sinon:e(t.explanation.sinon)},n},U={constant:e=>e};function q(e,t){if(U??={},U[e])throw new m("EvaluationError",`Multiple evaluation functions registered for the nodeKind \x1b[4m${e}`,{dottedName:""});U[e]=t}var z={isNullable:void 0,type:void 0};function F(e,t,n){function r(e){if(!e||"object"!=typeof e)return z;if(n.has(e))return n.get(e);n.set(e,z);const a=function(e){switch(e.nodeKind){case"bar\xe8me":case"dur\xe9e":case"grille":case"taux progressif":case"inversion":case"recalcul":case"replacementRule":case"r\xe9soudre r\xe9f\xe9rence circulaire":return{isNullable:!1,type:"number"};case"est non d\xe9fini":case"est non applicable":return{isNullable:!1,type:"boolean"};case"constant":return{isNullable:e.isNullable??null===e.nodeValue,type:e.type};case"operation":return{isNullable:["<","<=",">",">=","/","*"].includes(e.operationKind)?r(e.explanation[0]).isNullable||r(e.explanation[1]).isNullable:"-"===e.operationKind&&r(e.explanation[0]).isNullable,type:["<","<=",">",">=","=","!=","et","ou"].includes(e.operationKind)?"boolean":"number"};case"texte":case"une possibilit\xe9":return{isNullable:!1,type:"string"};case"rule":case"arrondi":return r(e.explanation.valeur);case"unit\xe9":case"simplifier unit\xe9":case"variable manquante":return r(e.explanation);case"condition":return{isNullable:[e.explanation.si,e.explanation.alors,e.explanation.sinon].some((e=>r(e).isNullable)),type:r(e.explanation.alors).type??r(e.explanation.sinon).type};case"variations":const n=e.explanation.map((e=>{let{consequence:t}=e;return r(t)}));return{isNullable:n.some((e=>e.isNullable)),type:n.map((e=>e.type)).find((e=>void 0!==e))};case"reference":return r(t[e.dottedName])}}(e);return n.set(e,a),a}return e.forEach((e=>{const n=t[e];r(n),n.explanation.parents.forEach(r)})),n}function B(e,t,n){let r,a;function i(i,s){r??=jn(n,En({dottedName:"INLINE_MECANISM"})),a??={};for(const e in t)"par d\xe9faut"in t[e]&&(a[e]=jn(t[e]["par d\xe9faut"],En({})));1===Object.keys(t).length&&"valeur"in t&&(i={valeur:i});const o={};for(const e in i)o[e]=jn(i[e],s);const l=j((n=>{if("reference"!==n.nodeKind||!(n.name in t))return;const r=n.name;if(r in o)return o[r];if(r in a)return a[r];throw new m("SyntaxError",`Il manque la cl\xe9 '${r} dans le m\xe9canisme ${e}`,{dottedName:r})}))(r);return l.sourceMap={mecanismName:e,args:o},l}return i.nom=e,Object.assign(i,"name",{value:`parse${J(e)}Inline`})}function W(e,t,n){function r(r,a){1===Object.keys(t).length&&"valeur"in t&&(r={valeur:r});const i={};for(const e in r){const t=r[e];i[e]=Array.isArray(t)?t.map((e=>jn(e,a))):jn(t,a)}const s=jn(n(i),a);return s.sourceMap={mecanismName:e,args:i},s}return r.nom=e,Object.assign(r,"name",{value:`parse${J(e)}Inline`})}function J(e){return e.replace(/(?:^\w|[A-Z]|\b\w)/g,(e=>e.toUpperCase())).replace(/\s+/g,"")}var H={nodeKind:"constant",nodeValue:null,missingVariables:{},type:void 0,isNullable:!0},Z={nodeKind:"constant",nodeValue:void 0,missingVariables:{},type:void 0,isNullable:!1},G={...Z,type:"number"},X=B("abattement",{abattement:{},valeur:{}},{"-":["valeur","abattement"],plancher:0}),Y=B("applicable si",{"applicable si":{},valeur:{}},{condition:{si:"applicable si != non",alors:"valeur",sinon:H}}),Q=e=>"missingVariables"in e?e.missingVariables:{},ee=function(e){return void 0===e&&(e={}),Object.fromEntries(Object.entries(e).map((e=>{let[t,n]=e;return[t,n+1]})))},te=function(e,t){return void 0===e&&(e={}),void 0===t&&(t={}),Object.fromEntries([...Object.keys(e),...Object.keys(t)].map((n=>[n,(e[n]??0)+(t[n]??0)])))},ne=e=>e.map(Q).reduce(te,{}),re=e=>({nodeValue:e,type:typeof e,isDefault:!0,nodeKind:"constant"}),ae=function(e,t){void 0===t&&(t=e=>e);const[n,...r]=e.split("/").map((e=>e.trim())),a=e=>function(e){let t=se(e);return Object.entries(t).flatMap((e=>{let[t,n]=e;return Array(n).fill(t)}))}(e.split(".").filter(Boolean).map((e=>t(e))));return{numerators:a(n),denominators:r.flatMap((e=>a(e)))}},ie=/(\d+)(?!.*[A-Za-z])/g;function se(e){let t={};return e.forEach((e=>{const n=e.match(ie);if(null!=n){const r=n[0],a=e.split(r)[0];t[a]=(t[a]??0)+ +r}else t[e]=(t[e]??0)+1})),t}var oe=function(e,t,n){return void 0===n&&(n=e=>e),function(e){let t=se(e);return Object.entries(t).map((e=>{let[t,n]=e;return n>1?`${t}${n}`:t}))}(e.map((e=>n(e,t)))).join(".")},le=2;function ue(e,t,n){if(void 0===t&&(t=le),void 0===n&&(n=e=>e),null===e||"object"!=typeof e)return"string"==typeof e?n(e,t):e;const r=he(e),{numerators:a=[],denominators:i=[]}=r,s=a.length>0,o=i.length>0;return s||o?s&&!o?oe(a,t,n):!s&&o?`/${oe(i,1,n)}`:`${oe(a,le,n)} / ${oe(i,1,n)}`:""}var de={numerators:[],denominators:[]},ce=(e,t)=>{if("/"===e){if(2!==t.length)throw new m("InternalError","Infer units of a division with units.length !== 2)",{});return ce("*",[t[0]||de,{numerators:(t[1]||de).denominators,denominators:(t[1]||de).numerators}])}const n=t.filter(Boolean);return n.length<=1?n[0]:"*"===e?he({numerators:n.flatMap((e=>e?.numerators??[])),denominators:n.flatMap((e=>e?.denominators??[]))}):"-"===e||"+"===e?t.find((e=>e)):void 0},pe=(e,t)=>Array.isArray(e)&&Array.isArray(t)?e.length===t.length&&e.every(((n,r)=>e[r]===t[r])):e===t,me=function(e,t){return void 0===t&&(t=pe),n=>{const r=n.findIndex((n=>t(n,e)));return n.filter(((e,t)=>t!==r))}},he=function(e,t){void 0===t&&(t=pe);return[...e.numerators,...e.denominators].reduce(((e,n)=>{let{numerators:r,denominators:a}=e;return r.find((e=>t(n,e)))&&a.find((e=>t(n,e)))?{numerators:me(n,t)(r),denominators:me(n,t)(a)}:{numerators:r,denominators:a}}),e)},fe={"mois/an":12,"jour/an":365,"jour/mois":365/12,"trimestre/an":4,"mois/trimestre":3,"jour/trimestre":91.25,"\u20ac/k\u20ac":1e3,"g/kg":1e3,"mg/g":1e3,"mg/kg":10**6,"m/km":1e3,"cm/m":100,"mm/cm":10,"mm/m":1e3,"cm/km":10**5,"mm/km":10**6};function xe(e,t){return fe[`${t}/${e}`]||fe[`${e}/${t}`]&&1/fe[`${e}/${t}`]}function ve(e,t){let n=100**(t.filter((e=>"%"===e)).length-e.filter((e=>"%"===e)).length);return[n]=e.reduce(((e,t)=>{let[n,r]=e;const a=r.findIndex((e=>!!xe(t,e)));return[n*(xe(t,r[a])||1),[...r.slice(0,a+1),...r.slice(a+1)]]}),[n,t]),n}var ge={"kW.h":"kWh","mn / h":"noeud"};function be(e,t,n){const r=ue(e),a=ue(t);if(!function(e,t){return!(!e||!t||e!==t&&e!==ge[t]&&t!==ge[e])}(r,a)&&!function(e,t){if(null==e||null==t)return!0;const n=e=>e.reduce(((e,t)=>{const n=je.findIndex((e=>e.has(t))),r=-1===n?t:""+n;return{...e,[r]:1+(e[r]??0)}}),{}),[r,a,i,s]=[e.numerators,e.denominators,t.numerators,t.denominators].map(n),o=e=>[...new Set(e)],l=[r,a,i,s].map(Object.keys).flat();return o(l).every((e=>(r[e]||0)-(a[e]||0)==(i[e]||0)-(s[e]||0)||"%"===e))}(e,t))throw new m("EngineError",`Impossible de convertir l'unit\xe9 '${r}' en '${a}'`,{});if(!n)return n;if(void 0===e)return n;const[i,s]=$e(e||de),[o,l]=$e(t||de);return we(n*s/l*ve(i.numerators,o.numerators)*ve(o.denominators,i.denominators))}var ye,je=(ye=fe,Object.keys(ye).reduce(((e,t)=>{const[n,r]=t.split("/"),a=e.findIndex((e=>e.has(n))),i=e.findIndex((e=>e.has(r)));if(a>-1&&i>-1&&a!==i)throw new m("EngineError",`Invalid ratio ${t}`,{});return-1===a&&-1===i?e.push(new Set([n,r])):a>-1?e[a].add(r):i>-1&&e[i].add(n),e}),[]));function Ne(e,t){return e===t||je.some((n=>n.has(e)&&n.has(t)))}function we(e){return+e.toFixed(16)}function Ve(e){const{numerators:t,denominators:n}=he(e,Ne);return t.length&&t.every((e=>"%"===e))?{numerators:["%"],denominators:n}:ke({numerators:t,denominators:n})}function $e(e,t){void 0===t&&(t=1);const n=ve(e.numerators,e.denominators);return[he(ke(e),Ne),t?we(t*n):t]}var ke=e=>({numerators:e.numerators.filter((e=>"%"!==e)),denominators:e.denominators.filter((e=>"%"!==e))});function Ee(e,t){return+e.toFixed(t)}function Se(e,t){return{explanation:{valeur:jn(e.valeur,t),arrondi:jn(e.arrondi,t)},nodeKind:Se.nom}}function Re(e,t){Object.entries(e.avec).forEach((e=>{let[n,r]=e;jn({nom:n,...null==r?{}:"object"!=typeof r||"nodeKind"in r?{valeur:r}:r},t)}));return jn(e.valeur,t)}Se.nom="arrondi",q(Se.nom,(function(e){const t=Fe(this.evaluateNode(e.explanation.valeur)),n=t.nodeValue;let r=e.explanation.arrondi;if(!1!==n&&(r=this.evaluateNode(r),"number"==typeof r.nodeValue&&!ue(r.unit)?.match(/d\xe9cimales?/)))throw new m("EvaluationError",`L'unit\xe9 ${ue(r.unit)} de l'arrondi est inconnu. Vous devez utiliser l'unit\xe9 \u201cd\xe9cimales\u201d`,{dottedName:this.cache._meta.evaluationRuleStack[0]});return{...e,nodeValue:"number"==typeof t.nodeValue&&"nodeValue"in r?"number"==typeof r.nodeValue?Ee(t.nodeValue,r.nodeValue):!0===r.nodeValue?Ee(t.nodeValue,0):void 0===r.nodeValue?void 0:t.nodeValue:t.nodeValue,explanation:{valeur:t,arrondi:r},missingVariables:ne([t,r]),unit:t.unit}})),Re.nom="avec";var Oe=(e,t)=>e.map(((n,r)=>{if(!n.plafond&&r>e.length)throw new m("SyntaxError",`La tranche n\xb0${r} du bar\xe8me n'a pas de plafond pr\xe9cis\xe9. Seule la derni\xe8re tranche peut ne pas \xeatre plafonn\xe9e`,{dottedName:""});return{...n,...void 0!==n.taux?{taux:jn(n.taux,t)}:{},...void 0!==n.montant?{montant:jn(n.montant,t)}:{},plafond:"plafond"in n?jn(n.plafond,t):{nodeValue:1/0,nodeKind:"constant",type:"number",isNullable:!1}}}));function Ie(e){let{multiplicateur:t,assiette:n,parsedTranches:r}=e;return r.reduce(((e,r,a)=>{let[i,s]=e;if(s)return[[...i,{...r,isAfterActive:!0}],s];const o=this.evaluateNode(r.plafond),l=i[a-1]?i[a-1].plafond:{nodeValue:0};let u=void 0===o.nodeValue||void 0===t.nodeValue?void 0:o.nodeValue*t.nodeValue;try{u=u===1/0||0===u?u:be(ce("*",[o.unit,t.unit]),n.unit,u)}catch(f){v(this.context.logger,`L'unit\xe9 du plafond de la tranche n\xb0${a+1}  n'est pas compatible avec celle l'assiette`,{dottedName:this.cache._meta.evaluationRuleStack[0]},f)}const d=i[a-1]?i[a-1].plafondValue:0,c=void 0===d||void 0===n.nodeValue?void 0:d>n.nodeValue,p=[o,n,t,l];if(p.some((e=>void 0===e.nodeValue)))return[[...i,{...r,plafond:o,plafondValue:u,plancherValue:d,nodeValue:void 0,isActive:void 0,isAfterActive:c,missingVariables:ne(p)}],!1];if(i[a-1]&&d&&u<=d)throw new m("EvaluationError",`Le plafond de la tranche n\xb0${a+1} a une valeur inf\xe9rieure \xe0 celui de la tranche pr\xe9c\xe9dente`,{dottedName:this.cache._meta.evaluationRuleStack[0]});const h={...r,plafond:o,plancherValue:d,plafondValue:u,isAfterActive:c,isActive:n.nodeValue>=d&&n.nodeValue<u};return[[...i,h],h.isActive]}),[[],!1])[0]}q("bar\xe8me",(function(e){const t=this.evaluateNode.bind(this),n=this.evaluateNode(e.explanation.assiette),r=this.evaluateNode(e.explanation.multiplicateur);if(0===r.nodeValue)throw new m("EvaluationError","Le multiplicateur ne peut pas \xeatre nul",{dottedName:this.cache._meta.evaluationRuleStack[0]});const a=function(e,t,n){return e.map((e=>{if(e.isAfterActive)return{...e,nodeValue:0};const r=n(e.taux),a=ne([r,e]);return[t.nodeValue,r.nodeValue,e.plafondValue,e.plancherValue].some((e=>void 0===e))?{...e,taux:r,nodeValue:void 0,missingVariables:a}:{...e,taux:r,..."unit"in t&&{unit:t.unit},nodeValue:(Math.min(t.nodeValue,e.plafondValue)-e.plancherValue)*be(r.unit,ae(""),r.nodeValue),missingVariables:a}}))}(Ie.call(this,{parsedTranches:e.explanation.tranches,assiette:n,multiplicateur:r}),n,t),i=a.reduce(((e,t)=>{let{nodeValue:n}=t;return null==n?void 0:e+n}),0);return{...e,nodeValue:i,missingVariables:ne([n,r,...a]),explanation:{assiette:n,multiplicateur:r,tranches:a},unit:n.unit}}));var Ce=(e,t,n)=>{const{composantes:r,...a}=t,i=jn({somme:r.map((t=>{const{attributs:n,...r}=t;return{...n,valeur:{[e]:{...a,...r}}}}))},n);return{...i,sourceMap:{args:{},...i.sourceMap,mecanismName:"composantes"}}};function Pe(e,t){return{explanation:{si:jn(e.si,t),alors:jn(e.alors,t),sinon:jn(e.sinon,t)},nodeKind:"condition"}}function Ae(e){let[t,n,r]=e.split("/");return r||([t,n,r]=["01",t,n]),Te(+r,+n,+t)}Pe.nom="condition",q("condition",(function(e){let t;const n=this.evaluateNode(e.explanation.si);let r=e.explanation.alors,a=e.explanation.sinon;if("unit"in n)throw new m("EvaluationError","La condition doit \xeatre de type bool\xe9en",{dottedName:this.cache._meta.evaluationRuleStack[0]});if(!0===n.nodeValue)r=this.evaluateNode(e.explanation.alors),r.isActive=!0,t=r;else if(!1===n.nodeValue)a=this.evaluateNode(e.explanation.sinon),t=a;else if(null===n.nodeValue)t=n;else{if(void 0!==n.nodeValue)throw new m("EvaluationError","La condition doit \xeatre de type bool\xe9en",{dottedName:this.cache._meta.evaluationRuleStack[0]});a=this.evaluateNode(e.explanation.sinon),r=this.evaluateNode(e.explanation.alors),t={...n,missingVariables:ne([a,r])}}const i=t.unit??r.unit;return{...t,missingVariables:te(ee(n.missingVariables),t.missingVariables),...null!=i?{unit:i}:{},...e,explanation:{si:n,alors:r,sinon:a}}}));var _e=e=>+e<10?`0${e}`:""+e;function Te(e,t,n){const r=new Date(+e,+t-1,+n);if(!+r||r.getDate()!==+n)throw new m("SyntaxError",`La date ${n}/${t}/${e} n'est pas valide`,{dottedName:""});return`${_e(n)}/${_e(t)}/${_e(e)}`}function De(e){const[t,n,r]=Ae(e).split("/"),a=new Date(+r,+n-1,+t);return a.setMinutes(a.getMinutes()-a.getTimezoneOffset()),a}var Me,Le=Te((Me=new Date).getFullYear(),Me.getMonth()+1,Me.getDate()),Ke={depuis:re(Le),"jusqu'\xe0":re(Le)};function Ue(e,t){return{explanation:jn(e,t),nodeKind:"est non d\xe9fini"}}q("dur\xe9e",(function(e){const t=this.evaluateNode(e.explanation.depuis),n=this.evaluateNode(e.explanation["jusqu'\xe0"]);let r;if([t,n].some((e=>{let{nodeValue:t}=e;return void 0===t})))r=void 0;else{const[e,a]=[t.nodeValue,n.nodeValue].map(De);r=Math.max(0,Math.round((a.getTime()-e.getTime())/864e5))}return{...e,missingVariables:ne([t,n]),nodeValue:r,explanation:{depuis:t,"jusqu'\xe0":n}}})),Ue.nom="est non d\xe9fini";var qe=B("est d\xe9fini",{valeur:{}},{"=":[{"est non d\xe9fini":"valeur"},"non"]}),ze=B("est applicable",{valeur:{}},{"=":[{"est non applicable":"valeur"},"non"]});function Fe(e){if(!e.unit)return e;return Be(Ve(e.unit),e)}function Be(e,t){return{...t,nodeValue:t.unit&&"number"==typeof t.nodeValue?be(t.unit,e,t.nodeValue):t.nodeValue,unit:e}}q("est non d\xe9fini",(function(e){const t=this.evaluateNode(e.explanation);let n=!1;return void 0===t.nodeValue&&(n=!0),{...e,nodeValue:n,missingVariables:t.missingVariables,explanation:t}}));var We=e=>{let{style:t,maximumFractionDigits:n=2,minimumFractionDigits:r=0,language:a}=e;return e=>{const i="currency"===t&&n>=2&&0===r&&!Number.isInteger(e)?2:r;return Intl.NumberFormat(a,{style:t,currency:"EUR",maximumFractionDigits:n,minimumFractionDigits:i}).format(e)}};function Je(e){return e&&e[0].toUpperCase()+e.slice(1)}var He={fr:{true:"oui",false:"non"},en:{true:"yes",false:"no"}};function Ze(e,t){let{language:n="fr",displayedUnit:r,formatUnit:a,precision:i=2}=void 0===t?{}:t,s="number"==typeof e||null==e?e:e.nodeValue;if("number"==typeof s&&Number.isNaN(s))return"Erreur dans le calcul du nombre";if(void 0===s)return"Pas encore d\xe9fini";if(null===s)return"Non applicable";if("string"==typeof s)return s.replace("\\n","\n");if("object"==typeof s)return s.nom;if("boolean"==typeof s)return He[n][s];if("number"==typeof s){let t="number"!=typeof e&&void 0!==e&&"unit"in e?e.unit:void 0;if(t){const e=Fe({unit:t,nodeValue:s});t=e.unit,s=e.nodeValue}return function(e){let{maximumFractionDigits:t,minimumFractionDigits:n,language:r,formatUnit:a,unit:i,nodeValue:s}=e;if("number"!=typeof s)return s;const o=i?ue(i,s,a):void 0;switch(o){case"\u20ac":return We({style:"currency",maximumFractionDigits:t,minimumFractionDigits:n,language:r})(s);case"%":return We({style:"percent",maximumFractionDigits:t,language:r})(s/100);default:return We({style:"decimal",minimumFractionDigits:n,maximumFractionDigits:t,language:r})(s)+("string"==typeof o?`\xa0${o}`:"")}}({minimumFractionDigits:0,maximumFractionDigits:i,language:n,formatUnit:a,nodeValue:s,unit:r??t}).trim()}}var Ge={};function Xe(e,t){return null!=e&&Object.prototype.hasOwnProperty.call(e,t)}function Ye(e){return function(){return e}}((e,t)=>{for(var n in t)a(e,n,{get:t[n],enumerable:!0})})(Ge,{contextNameToDottedName:()=>pt,cyclicDependencies:()=>it,decodeRuleName:()=>ct,disambiguateReference:()=>bt,disambiguateReferenceNode:()=>Nt,encodeRuleName:()=>dt,findCommonAncestor:()=>xt,getChildrenRules:()=>ft,isAccessible:()=>vt,isExperimental:()=>gt,nameLeaf:()=>ut,ruleParent:()=>mt,ruleParents:()=>ht,ruleWithDedicatedDocumentationPage:()=>yt,updateReferencesMapsFromReferenceNode:()=>jt});var Qe=(e,t)=>{e[t]?e[t]++:e[t]=1},et=(e,t)=>{--e[t]||delete e[t]},tt=(e,t,n,r)=>{let a=""+t,i=""+n;if(!e&&a>i){const e=a;a=i,i=e}return a+"\x01"+i+"\x01"+(void 0===r?"\0":r)},nt=(e,t)=>tt(e,t.v,t.w,t.name),rt=class{_nodeCount=0;_edgeCount=0;_isDirected;_label;_defaultNodeLabelFn;_defaultEdgeLabelFn;_nodes;_in;_preds;_out;_sucs;_edgeObjs;_edgeLabels;constructor(e){void 0===e&&(e={}),this._isDirected=!Xe(e,"directed")||e.directed,this._label=void 0,this._defaultNodeLabelFn=Ye(void 0),this._defaultEdgeLabelFn=Ye(void 0),this._nodes={},this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}isDirected(){return this._isDirected}setGraph(e){return this._label=e,this}graph(){return this._label}nodeCount(){return this._nodeCount}nodes(){return Object.keys(this._nodes)}setNode(e,t){return void 0===t&&(t=void 0),Xe(this._nodes,e)?(arguments.length>1&&(this._nodes[e]=t),this):(this._nodes[e]=arguments.length>1?t:this._defaultNodeLabelFn(e),this._in[e]={},this._preds[e]={},this._out[e]={},this._sucs[e]={},++this._nodeCount,this)}setNodes(e,t){return e.forEach((e=>{void 0!==t?this.setNode(e,t):this.setNode(e)})),this}node(e){return this._nodes[e]}hasNode(e){return Xe(this._nodes,e)}successors(e){const t=this._sucs[e];if(t)return Object.keys(t)}edgeCount(){return this._edgeCount}edges(){return Object.values(this._edgeObjs)}setEdge(e,t,n,r){void 0===n&&(n=void 0),void 0===r&&(r=void 0),e=""+e,t=""+t;const a=tt(this._isDirected,e,t,r);if(Xe(this._edgeLabels,a))return void 0!==n&&(this._edgeLabels[a]=n),this;this.setNode(e),this.setNode(t),this._edgeLabels[a]=void 0!==n?n:this._defaultEdgeLabelFn(e,t,r);const i=((e,t,n,r)=>{let a=""+t,i=""+n;if(!e&&a>i){const e=a;a=i,i=e}const s={v:a,w:i};return r&&(s.name=r),s})(this._isDirected,e,t,r);return e=i.v,t=i.w,Object.freeze(i),this._edgeObjs[a]=i,Qe(this._preds[t],e),Qe(this._sucs[e],t),this._in[t][a]=i,this._out[e][a]=i,this._edgeCount++,this}edge(e,t,n){const r=1===arguments.length?nt(this._isDirected,arguments[0]):tt(this._isDirected,e,t,n);return this._edgeLabels[r]}hasEdge(e,t,n){const r=1===arguments.length?nt(this._isDirected,arguments[0]):tt(this._isDirected,e,t,n);return Xe(this._edgeLabels,r)}removeEdge(e,t,n){const r=1===arguments.length?nt(this._isDirected,arguments[0]):tt(this._isDirected,e,t,n),a=this._edgeObjs[r];return a&&(e=a.v,t=a.w,delete this._edgeLabels[r],delete this._edgeObjs[r],et(this._preds[t],e),et(this._sucs[e],t),delete this._in[t][r],delete this._out[e][r],this._edgeCount--),this}outEdges(e,t){void 0===t&&(t=void 0);const n=this._out[e];if(n){const e=Object.values(n);return void 0===t?e:e.filter((function(e){return e.w===t}))}}};function at(e){let t=0;const n=[],r={},a=[];function i(s){const o=r[s]={onStack:!0,lowlink:t,index:t++};if(n.push(s),e.successors(s).forEach((function(e){Object.prototype.hasOwnProperty.call(r,e)?r[e].onStack&&(o.lowlink=Math.min(o.lowlink,r[e].index)):(i(e),o.lowlink=Math.min(o.lowlink,r[e].lowlink))})),o.lowlink===o.index){const e=[];let t;do{t=n.pop(),r[t].onStack=!1,e.push(t)}while(s!==t);a.push(e)}}return e.nodes().forEach((function(e){Object.prototype.hasOwnProperty.call(r,e)||i(e)})),a}function it(e){const{referencesMaps:t}=Rn(e),n=function(e){const t=new rt;return[...e.entries()].forEach((e=>{let[n,r]=e;r.forEach((e=>{t.setEdge(n,e)}))})),t}(t.referencesIn);var r;const a=at(r=n).filter((function(e){return e.length>1||1===e.length&&r.hasEdge(e[0],e[0])})).map((e=>e.reverse())),i=a.map((e=>function(e,t){function*n(e){let n=e;for(;;)yield t[n++%t.length]}const r=[];for(let a=0;a<t.length;a++){const t=[];let i;for(const r of n(a))if(void 0===i)t.push(r),i=r;else if(e.get(i)?.has(r)){if(t.includes(r)){t.splice(0,t.lastIndexOf(r));break}t.push(r),i=r}r.push(t)}return r.reduce(((e,t)=>t.length>e.length?e:t))}(t.referencesIn,e))),s=a.map(((e,t)=>function(e,t,n){const r=new Set;return t.forEach((a=>{e.outEdges(a).filter((e=>{let{w:n}=e;return t.includes(n)})).forEach((e=>{let{v:t,w:a}=e;r.add(`"${t}" -> "${a}"`+(st(n,t,a)?" [color=red]":""))}))})),`digraph Cycle {\n\t${[...r].join(";\n\t")};\n}`}(n,e,i[t])));return[i,s]}var st=(e,t,n)=>{for(let r=0;r<e.length+1;r++)if(t===e[r]&&n===e[(r+1)%e.length])return!0;return!1};var ot=e=>e.split(" . "),lt=e=>e.join(" . "),ut=e=>ot(e).slice(-1)?.[0],dt=e=>e?.replace(/\s\.\s/g,"/").replace(/-/g,"\u2011").replace(/\s/g,"-"),ct=e=>e.replace(/\//g," . ").replace(/-/g," ").replace(/\u2011/g,"-"),pt=e=>e.endsWith("$SITUATION")?mt(e):e,mt=e=>lt(ot(e).slice(0,-1));function ht(e){return ot(e).slice(0,-1).map(((e,t,n)=>lt(n.slice(0,t+1)))).reverse()}var ft=(e,t)=>Object.keys(e).filter((e=>e.startsWith(t)&&ot(e).length===ot(t).length+1));function xt(e,t){const n=ot(e),r=ot(t),a=n.findIndex(((e,t)=>r[t]!==e));return-1===a?e:lt(n.slice(0,a))}function vt(e,t,n){if(!(n in e))throw new m("InternalError",`La r\xe8gle "${n}" n'existe pas`,{dottedName:n});const r=xt(t,n),a=[n,...ht(n),""];return a.slice(0,Math.max(a.indexOf(r)-1,0)).every((t=>!(t in e)||!1===e[t].private))}function gt(e,t){if(!(t in e))throw new m("InternalError",`La r\xe8gle "${t}" n'existe pas`,{dottedName:t});return[t,...ht(t)].some((t=>t in e&&"oui"===e[t].rawNode?.experimental))}function bt(e,t,n){void 0===t&&(t="");const r=[t,...ht(t),""].map((e=>e?e+" . "+n:n)).sort(((e,n)=>e===t?1:n===t?-1:0)).filter((t=>t in e)),a=r.find((n=>vt(e,t,n)));if(!r.length)throw new m("SyntaxError",`La r\xe9f\xe9rence "${n}" est introuvable.\nV\xe9rifiez que l'orthographe et l'espace de nom sont corrects`,{dottedName:pt(t)});if(!a)throw new m("SyntaxError",`La r\xe8gle "${r[0]}" n'est pas accessible depuis "${t}".\nCela vient du fait qu'elle est priv\xe9e ou qu'un de ses parent est priv\xe9`,{dottedName:pt(t)});return a}function yt(e){return!0!==e.virtualRule&&"groupe"!==e.type&&"texte"!==e.type&&"paragraphe"!==e.type&&"notification"!==e.type}function jt(e,t,n){"reference"===e.nodeKind&&(b(t.referencesIn,n??e.contextDottedName,e.dottedName),b(t.rulesThatUse,e.dottedName,n??e.contextDottedName))}function Nt(e,t){if("reference"===e.nodeKind)return e.dottedName||(e.dottedName=bt(t,e.contextDottedName,e.name),e.title=t[e.dottedName].title,e.acronym=t[e.dottedName].rawNode.acronyme),e}var wt=0,Vt={};function $t(e,t){return e?(Array.isArray(e)?e:[e]).map((e=>{"string"==typeof e&&(e={"r\xe8gle":e});const n=jn(e.r\u00e8gle,t),r=jn(e.par??t.dottedName,t),[a,i]=[e.dans??[],e["sauf dans"]??[]].map((e=>Array.isArray(e)?e:[e])).map((e=>e.map((e=>jn(e,t)))));return{nodeKind:"replacementRule",rawNode:e,definitionRule:jn(t.dottedName,t),replacedReference:n,replacementNode:r,whiteListedNames:a,blackListedNames:i,remplacementRuleId:wt++}})):[]}function kt(e,t){return $t(e,t).map((e=>({...e,replacementNode:H})))}function Et(e){let{newRules:t,previousReplacements:n,parsedRules:r,referencesMaps:a,logger:i}=e;const s=function(e){const t={};for(const n in e){const r=e[n];for(const e of r.replacements){if(!e.replacedReference.dottedName)throw new f(e);const n=e.replacedReference.dottedName;t[n]=[...t[n]??[],e]}}return t}(t),o=new Set([]);for(const h in s){const e=a.rulesThatUse.get(h)??[];for(const t of e)o.add(t)}const l=new Set(Object.keys(t).filter((e=>[...a.referencesIn.get(e)??new Set].some((e=>(n[e]??[]).length))))),u=(d=n,c=s,Object.entries(c).reduce(((e,t)=>{let[n,r]=t;return{...e,[n]:[...e[n]??[],...r]}}),d));var d,c;if(!l.size&&!o.size)return[r,u];const p=St(n,a,i),m=St(s,a,i);return l.forEach((e=>{r[e]=p(r[e])})),o.forEach((e=>{r[e]=m(r[e])})),[r,u]}function St(e,t,n){return j(((r,a)=>{if("replacementRule"===r.nodeKind||"inversion"===r.nodeKind||"une possibilit\xe9"===r.nodeKind)return!1;if("recalcul"===r.nodeKind)return{...r,explanation:{...r.explanation,recalculNode:a(r.explanation.recalculNode),amendedSituation:r.explanation.amendedSituation.map((e=>{let[t,n]=e;return[t,a(n)]}))}};if("reference"===r.nodeKind){if(!r.dottedName)throw new f(r);const a=function(e,t,n){const r=t.filter((t=>{let{definitionRule:n}=t;return n.dottedName!==e.contextDottedName})).filter((t=>{let{whiteListedNames:n}=t;return!n.length||n.some((t=>e.contextDottedName.startsWith(t.dottedName)))})).filter((t=>{let{blackListedNames:n}=t;return!n.length||n.every((t=>!e.contextDottedName.startsWith(t.dottedName)))})).sort(((e,t)=>{const n=+!!t.whiteListedNames.length-+!!e.whiteListedNames.length,r=+!!t.blackListedNames.length-+!!e.blackListedNames.length;return n||r}));if(!r.length)return e;if(r.length>1){!1&&v(n,`\n\t\t\t\tIl existe plusieurs remplacements pour la r\xe9f\xe9rence '${e.dottedName}'.\n\t\t\t\tLors de l'execution, ils seront r\xe9solus dans l'odre suivant :\n\t\t\t\t${r.map((e=>`\n\t- Celui d\xe9finit dans la r\xe8gle '${e.definitionRule.dottedName}'`))}\n\t\t\t\t\t`,{dottedName:e.contextDottedName})}const a=r.map((e=>e.remplacementRuleId)).join("-");return Vt[a]??={nodeKind:"variations",sourceMap:{mecanismName:"replacement"},rawNode:e.rawNode,explanation:[...r.map((e=>({condition:e.definitionRule,consequence:e.replacementNode}))),{condition:re(!0),consequence:e}]},Vt[a]}(r,e[r.dottedName]??[],n);return N((e=>(jt(e,t,r.contextDottedName),"continue")))(a),a}}))}function Rt(e,t){if(t.private)return{ruleDisabledByItsParent:!1,parentMissingVariables:{}};const n=e.context.nodesTypes,r=t.explanation.parents.find((e=>n.get(e)?.isNullable||"boolean"===n.get(e)?.type));if(!r)return{ruleDisabledByItsParent:!1,parentMissingVariables:{}};if(!e.cache._meta.parentRuleStack.includes(t.dottedName)){e.cache._meta.parentRuleStack.unshift(t.dottedName);let a=re(!1);if(n.get(r)?.isNullable&&(a=e.evaluateNode({nodeKind:"est non applicable",explanation:r})),!0!==a.nodeValue&&"boolean"===n.get(r)?.type&&(a=e.evaluateNode({nodeKind:"operation",operator:"=",operationKind:"=",explanation:[r,re(!1)]})),e.cache._meta.parentRuleStack.shift(),!0===a.nodeValue)return{ruleDisabledByItsParent:!0,parentMissingVariables:a.missingVariables??{},nullableParent:r}}let a={};if("boolean"===n.get(r)?.type){const t=e.evaluateNode(r);return a=t.missingVariables??{},{ruleDisabledByItsParent:!1===t.nodeValue,parentMissingVariables:a,nullableParent:r}}return{ruleDisabledByItsParent:!1,parentMissingVariables:a,nullableParent:r}}function Ot(e,t){return{explanation:jn(e,t),nodeKind:"est non applicable"}}q("rule",(function(e){const{ruleDisabledByItsParent:t,nullableParent:n,parentMissingVariables:r}=Rt(this,e);let a={...e.explanation.valeur,nodeValue:null,missingVariables:{}};t||(this.cache._meta.evaluationRuleStack.filter((t=>t===e.dottedName)).length>1?a={nodeValue:void 0}:(this.cache._meta.evaluationRuleStack.unshift(e.dottedName),a=this.evaluateNode(e.explanation.valeur),this.cache._meta.evaluationRuleStack.shift())),a.missingVariables??={},function(e,t,n){if(!0===t.private||!vt(e.context.parsedRules,"",t.dottedName))return;void 0!==n.nodeValue||Object.keys(n.missingVariables).length||(n.missingVariables[t.dottedName]=1)}(this,e,a);return{...a,missingVariables:te(a.missingVariables,r),...e,explanation:{parents:e.explanation.parents,valeur:a,nullableParent:n,ruleDisabledByItsParent:t}}})),Ot.nom="est non applicable";var It=e=>({nodeKind:"est non applicable",explanation:e});q("est non applicable",(function(e){const t=e.explanation;if(!1===this.context.nodesTypes.get(t)?.isNullable&&"rule"!==t.nodeKind)return{...e,nodeValue:!1,missingVariables:{}};if(this.cache.nodes.has(t)&&void 0!==this.cache.nodes.get(t))return{...e,nodeValue:null===this.cache.nodes.get(t)?.nodeValue,missingVariables:this.cache.nodes.get(t)?.missingVariables??{}};switch(t.nodeKind){case"rule":const{ruleDisabledByItsParent:n,parentMissingVariables:r}=Rt(this,t);if(n)return{...e,nodeValue:!0,missingVariables:r};const a=this.evaluateNode(It(t.explanation.valeur)),i=te(r,a.missingVariables);return!1===a.nodeValue&&this.context.nodesTypes.get(this.context.parsedRules[`${t.dottedName} . $SITUATION`])?.isNullable&&!Object.keys(a.missingVariables).length&&(i[t.dottedName]=1),{...e,nodeValue:a.nodeValue,missingVariables:i};case"reference":if(!t.dottedName)throw new m("InternalError","Missing dottedName",{});return{...this.evaluateNode(It(this.context.parsedRules[t.dottedName])),...e};case"condition":return{...this.evaluateNode({...t,explanation:{si:t.explanation.si,alors:It(t.explanation.alors),sinon:It(t.explanation.sinon)}}),...e}}const n=this.evaluateNode(t);return{...e,nodeValue:void 0===n.nodeValue?void 0:null===n.nodeValue,missingVariables:n.missingVariables}}));function Ct(e,t,n,r,a,i){void 0===r&&(r=0),void 0===a&&(a=100),void 0===i&&(i=0);let s,o,l,u,d,c,p=t,m=n,h=p,f=e(p),x=e(m),v=f;for(;a-- >0;){if(l=m-p,Math.abs(v)<Math.abs(x)&&(p=m,m=h,h=p,f=x,x=v,v=f),s=1e-15*Math.abs(m)+r/2,o=(h-m)/2,Math.abs(o)<=s||0===x)return m;if(Math.abs(l)>=s&&Math.abs(f)>Math.abs(x)){let e,t;const n=h-m;p===h?(e=x/f,u=n*e,d=1-e):(d=f/v,e=x/v,t=x/f,u=t*(n*d*(d-e)-(m-p)*(e-1)),d=(d-1)*(e-1)*(t-1)),u>0?d=-d:u=-u,u<.75*n*d-Math.abs(s*d)/2&&u<Math.abs(l*d/2)&&(o=u/d)}if(Math.abs(o)<s&&(o=o>0?s:-s),p=m,f=x,m+=o,x=e(m),(x>0&&v>0||x<0&&v<0)&&(h=p,v=f),Math.abs(x)<r)return m;Math.abs(x)<i&&(c=m)}return c}q("grille",(function(e){const t=this.evaluateNode.bind(this),n=this.evaluateNode(e.explanation.assiette),r=this.evaluateNode(e.explanation.multiplicateur);if(0===r.nodeValue)throw new m("EvaluationError","Le multiplicateur ne peut pas \xeatre nul",{dottedName:this.cache._meta.evaluationRuleStack[0]});const a=Ie.call(this,{parsedTranches:e.explanation.tranches,assiette:n,multiplicateur:r}).map((e=>{if(!1===e.isActive)return e;const n=t(e.montant);return{...e,montant:n,nodeValue:n.nodeValue,unit:n.unit,missingVariables:ne([n,e])}}));let i;const s=a.find((e=>e.isActive));i=s?[s]:!1===a[a.length-1].isAfterActive?[{nodeValue:!1}]:a.filter((e=>void 0===e.isActive));const o=!!i[0]&&(void 0===i[0].isActive?void 0:i[0].nodeValue);return{...e,nodeValue:o,missingVariables:ne([n,r,...i]),explanation:{...e.explanation,assiette:n,multiplicateur:r,tranches:a},unit:i[0]?.unit??void 0}}));q("inversion",(function(e){const t=this.shallowCopy();if(this.cache._meta.evaluationRuleStack.slice(1).includes(e.explanation.ruleToInverse))return{...G,...e};t.cache._meta.parentRuleStack=[...this.cache._meta.parentRuleStack],t.cache._meta.evaluationRuleStack=[...this.cache._meta.evaluationRuleStack];const n=e.explanation.inversionCandidates.find((e=>{if(this.cache._meta.evaluationRuleStack.includes(e.dottedName))return!1;const n=t.evaluateNode(t.context.parsedRules[`${e.dottedName} . $SITUATION`]);return"number"==typeof n.nodeValue&&!(e.dottedName in n.missingVariables)}));if(void 0===n)return{...e,nodeValue:void 0,missingVariables:{...Object.fromEntries(e.explanation.inversionCandidates.map((e=>[e.dottedName,1]))),[e.explanation.ruleToInverse]:1}};const r=t.evaluateNode(n);let a,i=0;t.setSituation({[n.dottedName]:G},{keepPreviousSituation:!0});const s=s=>(i++,t.setSituation({[e.explanation.ruleToInverse]:{nodeValue:s,nodeKind:"constant",type:"number",unit:r.unit}},{keepPreviousSituation:!0}),a=t.evaluateNode(n),a),o=r.nodeValue;let l;const u=o,d=s(u).nodeValue,c=void 0!==d?u*o*(d>o?.9:1.2)/d:2e3,p=s(c).nodeValue,m=this.context.inversionMaxIterations??10;if(void 0!==d||void 0!==p){l=Ct((e=>(e===u?d:e===c?p:s(e).nodeValue)-o),void 0!==p&&p<o&&(p>d||d>o)?c:void 0!==d&&d<o&&(d>p||p>o)?u:-1e6,void 0!==p&&p>o&&(p<d||d<o)?c:void 0!==d&&d>o&&(d<p||p<o)?u:1e8,.1,m,1)}return null==l&&(this.cache.inversionFail=!0),(a.traversedVariables??[]).forEach((e=>this.cache._meta.traversedVariablesStack[0].add(e))),{...e,nodeValue:l,unit:r.unit,explanation:{...e.explanation,inversionGoal:n,numberOfIteration:i},missingVariables:a.missingVariables}}));var Pt=W("le maximum de",{valeur:{type:"liste"}},(e=>{let{valeur:t}=e;return t.reduce(((e,t)=>({condition:{si:{"est non applicable":"$INTERNAL valeur"},alors:"$INTERNAL acc",sinon:{condition:{si:{ou:[{"est non applicable":"$INTERNAL acc"},{">":["$INTERNAL valeur","$INTERNAL acc"]}]},alors:"$INTERNAL valeur",sinon:"$INTERNAL acc"}}},avec:{"[priv\xe9] $INTERNAL valeur":t,"[priv\xe9] $INTERNAL acc":e}})),H)})),At=W("le minimum de",{valeur:{type:"liste"}},(e=>{let{valeur:t}=e;return t.reduce(((e,t)=>({condition:{si:{"est non applicable":"$INTERNAL valeur"},alors:"$INTERNAL acc",sinon:{condition:{si:{ou:[{"est non applicable":"$INTERNAL acc"},{"<":["$INTERNAL valeur","$INTERNAL acc"]}]},alors:"$INTERNAL valeur",sinon:"$INTERNAL acc"}}},avec:{"[priv\xe9] $INTERNAL valeur":t,"[priv\xe9] $INTERNAL acc":e}})),H)}));function _t(e){return e.reverse().reduce(((e,t)=>({"+":[t,e]})),H)}var Tt=W("somme",{valeur:{type:"liste"}},(e=>{let{valeur:t}=e;return _t([...t])})),Dt=W("moyenne",{valeur:{type:"liste"}},(e=>{let{valeur:t}=e;const n=[...t];return{"/":[_t(n),_t(n.map(Mt))]}}));function Mt(e){return{"applicable si":{"est applicable":e},valeur:1}}var Lt=B("non applicable si",{"non applicable si":{},valeur:{}},{condition:{si:"non applicable si = non",alors:"valeur",sinon:H}});q("une possibilit\xe9",(e=>({...e,missingVariables:{[e.context]:1},nodeValue:void 0})));var Kt={"*":[(e,t)=>e*t,"\xd7"],"/":[(e,t)=>e/t,"\u2215"],"+":[(e,t)=>e+t],"-":[(e,t)=>e-t,"\u2212"],"<":[(e,t)=>e<t],"<=":[(e,t)=>e<=t,"\u2264"],">":[(e,t)=>e>t],">=":[(e,t)=>e>=t,"\u2265"],"=":[(e,t)=>(e??!1)===(t??!1)],"!=":[(e,t)=>(e??!1)!==(t??!1),"\u2260"],et:[(e,t)=>(e??!1)&&(t??!1)],ou:[(e,t)=>(e??!1)||(t??!1)]},Ut=(e,t)=>(n,r)=>{const a=n.map((e=>jn(e,r)));return{...n,nodeKind:"operation",operationKind:e,operator:t||e,explanation:a}};q("operation",(function(e){let t=this.evaluateNode(e.explanation[0]),n={...e,missingVariables:{}};if(null===t.nodeValue&&["<",">","<=",">=","/","*","-","et"].includes(e.operationKind)||0===t.nodeValue&&["/","*"].includes(e.operationKind)||!1===t.nodeValue&&"et"===e.operationKind||!0===t.nodeValue&&"ou"===e.operationKind)return{...n,nodeValue:"et"!==e.operationKind&&t.nodeValue,missingVariables:t.missingVariables};let r=this.evaluateNode(e.explanation[1]);if(n.explanation=[t,r],"/"===e.operationKind&&0===r.nodeValue)throw new m("EvaluationError","Division by zero",{dottedName:this.cache._meta.evaluationRuleStack[0]});if(null===r.nodeValue&&["<",">","<=",">=","/","*","et"].includes(e.operationKind)||0===r.nodeValue&&["*"].includes(e.operationKind)||!1===r.nodeValue&&"et"===e.operationKind||!0===r.nodeValue&&"ou"===e.operationKind)return{...n,nodeValue:"et"!==e.operationKind&&r.nodeValue,missingVariables:r.missingVariables};n.missingVariables=ne([t,r]),void 0!==t.nodeValue&&void 0!==r.nodeValue||(n={...n,nodeValue:void 0});const a=["+","-"].includes(e.operationKind)&&"%"===ue(r.unit)&&"%"!==ue(t.unit);if(!("nodeValue"in n)&&!["/","*"].includes(e.operationKind)&&!a)try{t.unit&&"unit"in r?r=Be(t.unit,r):r.unit&&(t=Be(r.unit,t))}catch(l){v(this.context.logger,`Dans l'expression '${e.operationKind}', la partie gauche (unit\xe9: ${ue(t.unit)}) n'est pas compatible avec la partie droite (unit\xe9: ${ue(r.unit)})`,{dottedName:this.cache._meta.evaluationRuleStack[0]},l)}const i=Kt[e.operationKind][0],s=t.nodeValue,o=r.nodeValue;if(n.nodeValue="nodeValue"in n?n.nodeValue:["<",">","<=",">=","*","/"].includes(e.operationKind)&&null===r.nodeValue?null:[s,o].every((e=>"string"==typeof e&&e.match?.(/^[\d]{2}\/[\d]{2}\/[\d]{4}$/)))?i(De(s),De(o)):i(s,o),"*"===e.operationKind&&ce("*",[t.unit,r.unit])?.numerators.includes("%")){let e=ce("*",[t.unit,r.unit]);const a=n.nodeValue;return{...n,nodeValue:"number"==typeof a?a/100:a,unit:ce("*",[e,{numerators:[],denominators:["%"]}])}}if(a){let a=ce("*",[t.unit,r.unit]);return{...n,nodeValue:"number"==typeof t.nodeValue&&"number"==typeof r.nodeValue?t.nodeValue*(1+r.nodeValue/100*("-"===e.operationKind?-1:1)):n.nodeValue,unit:ce("*",[a,{numerators:[],denominators:["%"]}])}}return"*"===e.operationKind||"/"===e.operationKind||"-"===e.operationKind||"+"===e.operationKind?{...n,unit:ce(e.operationKind,[t.unit,r.unit])}:n}));var qt=Object.fromEntries(Object.entries(Kt).map((e=>{let[t,[n,r]]=e;return[t,Ut(t,r)]}))),zt=B("par d\xe9faut",{"par d\xe9faut":{},valeur:{}},{condition:{si:{"est non d\xe9fini":"valeur"},alors:"par d\xe9faut",sinon:"valeur"}}),Ft=B("plafond",{plafond:{},valeur:{}},{condition:{si:{et:["plafond != non","valeur > plafond"]},alors:"plafond",sinon:"valeur"}}),Bt=B("plancher",{plancher:{},valeur:{}},{condition:{si:{et:["plancher != non","valeur < plancher"]},alors:"plancher",sinon:"valeur"}}),Wt=B("produit",{assiette:{},taux:{"par d\xe9faut":"100%"},facteur:{"par d\xe9faut":1},plafond:{"par d\xe9faut":H}},{"*":[{"*":["taux","facteur"]},{valeur:"assiette",plafond:"plafond"}],"simplifier l'unit\xe9":"oui"});q("recalcul",(function(e){if(this.cache._meta.currentRecalcul===e.explanation.recalculNode)return{...H,...e};const t=Object.fromEntries(e.explanation.amendedSituation.filter((e=>{let[t,n]=e;const r=this.evaluateNode(t),a=this.evaluateNode(n);return r.nodeValue!==a.nodeValue||ue(r.unit)!==ue(a.unit)})).map((e=>{let[t,n]=e;return[t.dottedName,n]})));let n=this;Object.keys(t).length&&(n=this.shallowCopy().setSituation(t,{keepPreviousSituation:!0}),n.subEngineId=this.subEngines.length,Object.values(t).forEach((e=>n.cache.nodes.set(e,this.evaluate(e)))),this.subEngines.push(n)),n.cache._meta.currentRecalcul=e.explanation.recalculNode;const r=n.evaluateNode(e.explanation.recalculNode);return delete n.cache._meta.currentRecalcul,{...e,nodeValue:r.nodeValue,explanation:{...e.explanation,recalcul:r,subEngineId:n.subEngineId},missingVariables:r.missingVariables,..."unit"in r&&{unit:r.unit}}}));function Jt(e,t){return{explanation:{ruleToSolve:t.dottedName,valeur:jn(e.valeur,t)},nodeKind:"r\xe9soudre r\xe9f\xe9rence circulaire"}}function Ht(e,t){return{explanation:jn(e.valeur,t),nodeKind:"simplifier unit\xe9"}}Jt.nom="r\xe9soudre la r\xe9f\xe9rence circulaire",q("r\xe9soudre r\xe9f\xe9rence circulaire",(function(e){if(this.cache._meta.evaluationRuleStack.slice(1).includes(e.explanation.ruleToSolve))return{...G,...e};let t=0;const n=this.shallowCopy();n.cache._meta.parentRuleStack=[...this.cache._meta.parentRuleStack],n.cache._meta.evaluationRuleStack=[...this.cache._meta.evaluationRuleStack];const r=this.context.inversionMaxIterations??25,a=r=>(t++,n.setSituation({[e.explanation.ruleToSolve]:{...G,nodeValue:r}},{keepPreviousSituation:!0}),n.evaluateNode(e.explanation.valeur)),i=Symbol("inversion failed");let s=i;let o=a(1);const l=o.nodeValue,u=o.unit;if(void 0!==l){s=Ct((e=>{if(1===e)return l-1;o=a(e);const t=o.nodeValue;return t-e}),-1e6,1e8,.5,r,2)}return s===i&&(s=void 0,this.cache.inversionFail=!0),void 0!==s&&(o=a(s)),{...e,unit:u,nodeValue:s,explanation:{...e.explanation,valeur:o,numberOfIterations:t},missingVariables:o.missingVariables}})),Ht.nom="simplifier l'unit\xe9",q("simplifier unit\xe9",(function(e){const t=this.evaluateNode(e.explanation),n=t.nodeValue,r={...t,...e,explanation:t};if(null==n)return r;if(!t.unit)return{...r,unit:t.unit};const a=Ve(t.unit);return{...r,nodeValue:"number"==typeof n?be(t.unit,a,n):n,unit:a}}));var Zt=B("dans la situation",{valeur:{},"dans la situation":{}},{condition:{si:{"est non d\xe9fini":"dans la situation"},alors:"valeur",sinon:"dans la situation"}});q("taux progressif",(function(e){const t=this.evaluateNode.bind(this),n=this.evaluateNode(e.explanation.assiette),r=this.evaluateNode(e.explanation.multiplicateur);if(0===r.nodeValue)throw new m("EvaluationError","Division by zero",{dottedName:""});const a=Ie.call(this,{parsedTranches:e.explanation.tranches,assiette:n,multiplicateur:r}),i={...e,explanation:{tranches:a,assiette:n,multiplicateur:r},unit:ae("%")},s=a[a.length-1];if(a.every((e=>{let{isActive:t}=e;return!1===t}))||s.isActive&&s.plafond.nodeValue===1/0){const e=Be(ae("%"),t(s.taux)),{nodeValue:n,missingVariables:r}=e;return s.taux=e,s.nodeValue=n,s.missingVariables=r,{...i,nodeValue:n,missingVariables:r}}if(a.every((e=>{let{isActive:t}=e;return!0!==t}))||"number"!=typeof n.nodeValue)return{...i,nodeValue:void 0,missingVariables:ne(a)};const o=a.findIndex((e=>{let{isActive:t}=e;return!0===t})),l=a[o];l.taux=Be(ae("%"),t(l.taux));const u=a[o-1];u&&(u.taux=Be(ae("%"),t(u.taux)),u.isActive=!0);const d=u?u.taux:l.taux,c=[d,l.taux];if(c.some((e=>void 0===e.nodeValue)))return l.nodeValue=void 0,{...i,nodeValue:void 0,missingVariables:ne(c)};const p=d.nodeValue,h=l.taux.nodeValue,f=l.plancherValue,x=(h-p)/(l.plafondValue-f),v=p+(n.nodeValue-f)*x;return l.nodeValue=v,{...i,nodeValue:v,missingVariables:{}}}));var Gt="texte";function Xt(e,t){const n=[];let r=0;for(const{0:a,index:i}of e.matchAll(/{{(.|\n)*?}}/g)){const s=jn(a.slice(2,-2).trim(),t);n.push(e.substring(r,i),s),r=(i??0)+a.length}return n.push(e.slice(r)),{nodeKind:Gt,explanation:n}}Xt.nom=Gt,q(Gt,(function(e){const t=e.explanation.map((e=>"string"==typeof e?e:this.evaluateNode(e)));return{...e,explanation:t,missingVariables:ne(e.explanation.filter((e=>"string"!=typeof e))),nodeValue:t.map((e=>"string"==typeof e?e:Ze(e))).join("")}}));var Yt=W("toutes ces conditions",{valeur:{type:"liste"}},(e=>{let{valeur:t}=e;return t.reduce(((e,t)=>({et:[e,t]})),"oui")})),Qt=W("une de ces conditions",{valeur:{type:"liste"}},(e=>{let{valeur:t}=e;return t.reduce(((e,t)=>({ou:[e,t]})),"non")}));function en(e,t){return{explanation:jn(e.valeur,t),unit:ae(e.unit\u00e9,t.getUnitKey),nodeKind:en.nom}}function tn(e,t){return{missingVariable:e["variable manquante"],nodeKind:tn.nom,explanation:jn(e.valeur,t)}}en.nom="unit\xe9",q(en.nom,(function(e){const t=this.evaluateNode(e.explanation);let n=t.nodeValue;if(null!==n&&"unit"in e)try{n=be(t.unit,e.unit,t.nodeValue)}catch(r){v(this.context.logger,"Erreur lors de la conversion d'unit\xe9 explicite",{dottedName:this.cache._meta.evaluationRuleStack[0]},r)}return{...e,nodeValue:n,explanation:t,missingVariables:t.missingVariables}})),tn.nom="variable manquante",q(tn.nom,(function(e){const t=this.evaluateNode(e.explanation),n=Object.values(t.missingVariables).reduce(((e,t)=>e>t?e:t),0);return{...e,nodeValue:t.nodeValue,unit:t.unit,explanation:t,missingVariables:te(t.missingVariables,{[e.missingVariable]:n+1})}}));var nn=(e,t,n)=>{if("valeur"===e)return jn(t,n);const{variations:r,...a}=t;return jn({variations:r.map((t=>{let{alors:n,sinon:r,si:i}=t;const{attributs:s,...o}=n??r;return{[void 0!==n?"alors":"sinon"]:{...s,[e]:{...a,...o}},...void 0!==i&&{si:i}}}))},n)};q("variations",(function(e){const[t,n,r]=e.explanation.reduce(((e,t,n)=>{let[r,a,i,s]=e,{condition:o,consequence:l}=t;if(!0===s)return[r,[...a,{condition:o,consequence:l}],i,s];const u=this.evaluateNode(o),d=void 0===s?s:!s&&(void 0===u.nodeValue?void 0:!1!==u.nodeValue&&null!==u.nodeValue);if(!1===d||null===d)return[r,[...a,{condition:u,consequence:l}],i,s];let c;if(!1!==u.nodeValue&&null!==u.nodeValue&&(c=this.evaluateNode(l),i))try{c=Be(i,c)}catch(p){v(this.context.logger,`L'unit\xe9 de la branche n\xb0 ${n+1} du m\xe9canisme 'variations' n'est pas compatible avec celle d'une branche pr\xe9c\xe9dente`,{dottedName:this.cache._meta.evaluationRuleStack[0]},p)}return[d&&c?.nodeValue,[...a,{condition:u,consequence:c??l}],i||c?.unit,s||d]}),[null,[],void 0,!1]);return{...e,nodeValue:t,...void 0!==r&&{unit:r},explanation:n,missingVariables:n.reduce(((e,t)=>{let{condition:n,consequence:r}=t;return te(e,te(ee(n.missingVariables),"nodeValue"in n&&!1!==n.nodeValue&&null!==n.nodeValue?r.missingVariables:{}))}),{})}}));var rn=d(c(),1),an=e=>{let[t,,n,,r]=e;return{[n.value.toLowerCase()]:[t,r]}},sn=e=>{let[{value:t}]=e;console.log(t)},on=e=>{let[{value:t}]=e;return{constant:{type:"number",nodeValue:parseFloat(t)}}},ln=e=>{let[{value:t}]=e;return{constant:{type:"date",nodeValue:Ae(t)}}},un=e=>{let[{value:t}]=e;return{constant:{type:"boolean",nodeValue:"oui"===t}}},dn=e=>{let[{value:t}]=e;return{constant:{type:"string",nodeValue:t.slice(1,-1)}}};function cn(e){return e[0]}var pn="[a-zA-Z\xc0-\u017f\u20ac$%](?:[-']?[a-zA-Z\xc0-\u017f0-9',\xb0]+)*",mn=d(p(),1).default.compile({"(":"(",")":")","[":"[","]":"]",comparison:[">","<",">=","<=","=","!="],date:new RegExp("(?:(?:0?[1-9]|[12][0-9]|3[01])\\/)?(?:0?[1-9]|1[012])\\/\\d{4}"),boolean:["oui","non"],number:new RegExp("-?(?:[1-9][0-9]+|[0-9])(?:\\.[0-9]+)?"),word:new RegExp(pn),string:[/'.*'/,/".*"/],JSONObject:/{.*}/,additionSubstraction:/[\+-]/,multiplicationDivision:["*","/"],dot:" . ",".":".",space:{match:/[\s]+/,lineBreaks:!0}}),hn=e=>({value:e.map((e=>e&&e.value)).join("")}),fn=e=>{let[t,n]=e;return Array.isArray(n)?hn([t,...n]):t},xn={Lexer:mn,ParserRules:[{name:"main",symbols:["Comparison"],postprocess:cn},{name:"main",symbols:["NumericValue"],postprocess:cn},{name:"main",symbols:["Date"],postprocess:cn},{name:"main",symbols:["NonNumericTerminal"],postprocess:cn},{name:"main",symbols:["JSONObject"],postprocess:cn},{name:"NumericValue",symbols:["AdditionSubstraction"],postprocess:cn},{name:"NumericValue",symbols:["Negation"],postprocess:cn},{name:"NumericTerminal",symbols:["Variable"],postprocess:cn},{name:"NumericTerminal",symbols:["number"],postprocess:cn},{name:"Negation",symbols:[{literal:"-"},mn.has("space")?{type:"space"}:space,"Parentheses"],postprocess:e=>{let[t,,n]=e;return{[t]:[on([{value:"0"}]),n]}}},{name:"Parentheses",symbols:[{literal:"("},mn.has("space")?{type:"space"}:space,"NumericValue",mn.has("space")?{type:"space"}:space,{literal:")"}],postprocess:e=>{let[,,t]=e;return t}},{name:"Parentheses",symbols:[{literal:"("},"NumericValue",{literal:")"}],postprocess:e=>{let[,t]=e;return t}},{name:"Parentheses",symbols:["NumericTerminal"],postprocess:cn},{name:"Date",symbols:["Variable"],postprocess:cn},{name:"Date",symbols:[mn.has("date")?{type:"date"}:ln],postprocess:ln},{name:"Comparison",symbols:["Comparable",mn.has("space")?{type:"space"}:space,mn.has("comparison")?{type:"comparison"}:comparison,mn.has("space")?{type:"space"}:space,"Comparable"],postprocess:an},{name:"Comparison",symbols:["Date",mn.has("space")?{type:"space"}:space,mn.has("comparison")?{type:"comparison"}:comparison,mn.has("space")?{type:"space"}:space,"Date"],postprocess:an},{name:"Comparable$subexpression$1",symbols:["AdditionSubstraction"]},{name:"Comparable$subexpression$1",symbols:["NonNumericTerminal"]},{name:"Comparable",symbols:["Comparable$subexpression$1"],postprocess:e=>{let[[t]]=e;return t}},{name:"NonNumericTerminal",symbols:[mn.has("boolean")?{type:"boolean"}:un],postprocess:un},{name:"NonNumericTerminal",symbols:[mn.has("string")?{type:"string"}:dn],postprocess:dn},{name:"Variable$ebnf$1",symbols:[]},{name:"Variable$ebnf$1$subexpression$1",symbols:[mn.has("dot")?{type:"dot"}:dot,"Words"],postprocess:hn},{name:"Variable$ebnf$1",symbols:["Variable$ebnf$1","Variable$ebnf$1$subexpression$1"],postprocess:function(e){return e[0].concat([e[1]])}},{name:"Variable",symbols:["Words","Variable$ebnf$1"],postprocess:e=>(e=>{let{value:t}=e;return{variable:t}})(fn(e))},{name:"Words$ebnf$1$subexpression$1$ebnf$1",symbols:[mn.has("space")?{type:"space"}:space],postprocess:cn},{name:"Words$ebnf$1$subexpression$1$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"Words$ebnf$1$subexpression$1",symbols:["Words$ebnf$1$subexpression$1$ebnf$1","WordOrNumber"],postprocess:hn},{name:"Words$ebnf$1",symbols:["Words$ebnf$1$subexpression$1"]},{name:"Words$ebnf$1$subexpression$2$ebnf$1",symbols:[mn.has("space")?{type:"space"}:space],postprocess:cn},{name:"Words$ebnf$1$subexpression$2$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"Words$ebnf$1$subexpression$2",symbols:["Words$ebnf$1$subexpression$2$ebnf$1","WordOrNumber"],postprocess:hn},{name:"Words$ebnf$1",symbols:["Words$ebnf$1","Words$ebnf$1$subexpression$2"],postprocess:function(e){return e[0].concat([e[1]])}},{name:"Words",symbols:["WordOrKeyword","Words$ebnf$1"],postprocess:fn},{name:"Words",symbols:[mn.has("word")?{type:"word"}:pn],postprocess:cn},{name:"WordOrKeyword",symbols:[mn.has("word")?{type:"word"}:pn],postprocess:cn},{name:"WordOrKeyword",symbols:[mn.has("boolean")?{type:"boolean"}:un],postprocess:cn},{name:"WordOrNumber",symbols:["WordOrKeyword"],postprocess:cn},{name:"WordOrNumber",symbols:[mn.has("number")?{type:"number"}:on],postprocess:cn},{name:"UnitDenominator$ebnf$1$subexpression$1",symbols:[mn.has("space")?{type:"space"}:space]},{name:"UnitDenominator$ebnf$1",symbols:["UnitDenominator$ebnf$1$subexpression$1"],postprocess:cn},{name:"UnitDenominator$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"UnitDenominator",symbols:["UnitDenominator$ebnf$1",{literal:"/"},"Words"],postprocess:hn},{name:"UnitNumerator$ebnf$1$subexpression$1",symbols:[{literal:"."},"Words"]},{name:"UnitNumerator$ebnf$1",symbols:["UnitNumerator$ebnf$1$subexpression$1"],postprocess:cn},{name:"UnitNumerator$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"UnitNumerator",symbols:["Words","UnitNumerator$ebnf$1"],postprocess:fn},{name:"Unit$ebnf$1",symbols:["UnitNumerator"],postprocess:cn},{name:"Unit$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"Unit$ebnf$2",symbols:[]},{name:"Unit$ebnf$2",symbols:["Unit$ebnf$2","UnitDenominator"],postprocess:function(e){return e[0].concat([e[1]])}},{name:"Unit",symbols:["Unit$ebnf$1","Unit$ebnf$2"],postprocess:fn},{name:"AdditionSubstraction",symbols:["AdditionSubstraction",mn.has("space")?{type:"space"}:space,mn.has("additionSubstraction")?{type:"additionSubstraction"}:additionSubstraction,mn.has("space")?{type:"space"}:space,"MultiplicationDivision"],postprocess:an},{name:"AdditionSubstraction",symbols:["MultiplicationDivision"],postprocess:cn},{name:"MultiplicationDivision",symbols:["MultiplicationDivision",mn.has("space")?{type:"space"}:space,mn.has("multiplicationDivision")?{type:"multiplicationDivision"}:multiplicationDivision,mn.has("space")?{type:"space"}:space,"Parentheses"],postprocess:an},{name:"MultiplicationDivision",symbols:["Parentheses"],postprocess:cn},{name:"number",symbols:[mn.has("number")?{type:"number"}:on],postprocess:on},{name:"number$ebnf$1$subexpression$1",symbols:[mn.has("space")?{type:"space"}:space]},{name:"number$ebnf$1",symbols:["number$ebnf$1$subexpression$1"],postprocess:cn},{name:"number$ebnf$1",symbols:[],postprocess:function(e){return null}},{name:"number",symbols:[mn.has("number")?{type:"number"}:on,"number$ebnf$1","Unit"],postprocess:e=>({...on(e),"unit\xe9":e[2].value})},{name:"JSONObject",symbols:[mn.has("JSONObject")?{type:"JSONObject"}:sn],postprocess:sn}],ParserStart:"main"},{Grammar:vn,Parser:gn}=rn.default,bn=new gn(vn.fromCompiled(xn)),yn=bn.save();function jn(e,t){if(null==e)throw new m("SyntaxError","\n\tUne des valeurs de la formule est vide.\n\tV\xe9rifiez que tous les champs \xe0 droite des deux points sont remplis",{dottedName:t.dottedName});if("boolean"==typeof e)throw new m("SyntaxError","\nLes valeurs bool\xe9ennes true / false ne sont accept\xe9es.\nUtilisez leur contrepartie fran\xe7aise : 'oui' / 'non'",{dottedName:t.dottedName});const n="object"==typeof e?e:function(e,t){const n=(e+"").replace(/\s*\n\s*/g," ").trim();try{bn.restore(yn);const[e]=bn.feed(n).results;if(null==e)throw new m("InternalError",`\nUn probl\xe8me est survenu lors du parsing de l'expression \`${n}\` :\n\n\tle parseur Nearley n'a pas r\xe9ussi \xe0 parser l'expression.\n`,{dottedName:t});return e}catch(r){if(r instanceof m)throw r;throw new m("SyntaxError",`\`${n}\` n'est pas une expression valide`,{dottedName:t},r)}}(e,t.dottedName);return"nodeKind"in n?n:"nom"in n?function(e,t){const n=!("oui"!==e.priv\u00e9&&!e.nom.startsWith("[priv\xe9] ")),r=e.nom.replace(/^\[priv\xe9\] /,""),a=[t.dottedName,r].filter(Boolean).join(" . "),i=ut(a),s=Je(e.titre??i);if(t.parsedRules[a])throw new m("EvaluationError",`La r\xe9f\xe9rence '${a}' a d\xe9j\xe0 \xe9t\xe9 d\xe9finie`,{dottedName:a});const o={};for(const c in e)kn.includes(c)&&(o[c]=e[c]);"formule"in e&&(o.valeur=e.formule),n||a.endsWith("$SITUATION")||(o["dans la situation"]=`${a} . $SITUATION`,o.avec={...o.avec??{},"[priv\xe9] $SITUATION":{...Z,isNullable:"oui"===e["possiblement non applicable"]}},null!=o["par d\xe9faut"]&&(o["par d\xe9faut"]={valeur:o["par d\xe9faut"],"variable manquante":a}));const l={...t,dottedName:a};t.parsedRules[a]=void 0;const u={valeur:jn(o,l),parents:ht(a).map((e=>jn(e,l))).map((e=>(e.dottedName=e.name,e)))},d={};if(e.suggestions)for(const c in e.suggestions)d[c]=jn(e.suggestions[c],l);return t.parsedRules[a]={dottedName:a,replacements:[...kt(e["rend non applicable"],l),...$t(e.remplace,l)],title:s,private:n,suggestions:d,nodeKind:"rule",explanation:u,rawNode:e,virtualRule:!!t.dottedName},t.dottedName?jn(r,t):t.parsedRules[a]}(n,t):{...Vn(n,t),rawNode:e}}function Nn(e,t){if(Array.isArray(e))throw new m("SyntaxError",`\nIl manque le nom du m\xe9canisme pour le tableau : [${e.map((e=>`'${e}'`)).join(", ")}]\nLes m\xe9canisme possibles sont : 'somme', 'le maximum de', 'le minimum de', 'toutes ces conditions', 'une de ces conditions'.\n\t\t`,{dottedName:t.dottedName});const n=Object.keys(e);if(n.length>1)throw new m("SyntaxError",`\nLes m\xe9canismes suivants se situent au m\xeame niveau : ${n.map((e=>`'${e}'`)).join(", ")}\nCela vient probablement d'une erreur dans l'indentation\n\t`,{dottedName:t.dottedName});if(0===n.length)return{nodeKind:"constant",nodeValue:void 0};const r=n[0],a=e[r],i=$n[r];if(!i)throw new m("SyntaxError",`Le m\xe9canisme "${r}" est inconnu.\n\nV\xe9rifiez qu'il n'y ait pas d'erreur dans l'orthographe du nom.`,{dottedName:t.dottedName});try{return a?.composantes?Ce(r,a,t):a?.variations&&Object.values(a).length>1?nn(r,a,t):i(a,t)}catch(s){if(s instanceof m)throw s;throw new m("SyntaxError",r?`\u27a1\ufe0f Dans le m\xe9canisme ${r}\n${s.message}`:s.message,{dottedName:t.dottedName})}}q("reference",(function(e){if(!e.dottedName)throw new f(e);const t=this.evaluateNode(this.context.parsedRules[e.dottedName]);return delete t.sourceMap,{...t,...e}}));var wn=[tn,Re,Y,Lt,Se,en,Ht,Bt,Ft,zt,Zt,Jt,X];function Vn(e,t){const n=wn.find((t=>t.nom in e));if(!n)return Nn(e,t);const{[n.nom]:r,...a}=e;return Nn({[n.nom]:{valeur:a,[n.nom]:r}},t)}var $n={...qt,...wn.reduce(((e,t)=>({[t.nom]:t,...e})),{}),"inversion num\xe9rique":(e,t)=>{if(!e.avec)throw new m("SyntaxError","Une formule d'inversion doit pr\xe9ciser _avec_ quoi on peut inverser la variable",{dottedName:t.dottedName});return{explanation:{ruleToInverse:t.dottedName,inversionCandidates:e.avec.map((e=>({...jn(e,t)})))},nodeKind:"inversion"}},"le maximum de":Pt,"le minimum de":At,"taux progressif":function(e,t){return{explanation:{assiette:jn(e.assiette,t),multiplicateur:e.multiplicateur?jn(e.multiplicateur,t):re(1),tranches:Oe(e.tranches,t)},nodeKind:"taux progressif"}},"toutes ces conditions":Yt,"est non d\xe9fini":Ue,"est non applicable":Ot,"est applicable":ze,"est d\xe9fini":qe,"une de ces conditions":Qt,"une possibilit\xe9":(e,t)=>(Array.isArray(e)&&(e={"possibilit\xe9s":e}),{...e,explanation:e.possibilit\u00e9s.map((e=>jn(e,t))),context:t.dottedName,nodeKind:"une possibilit\xe9"}),condition:Pe,"bar\xe8me":function(e,t){return{explanation:{assiette:jn(e.assiette,t),multiplicateur:e.multiplicateur?jn(e.multiplicateur,t):re(1),tranches:Oe(e.tranches,t)},nodeKind:"bar\xe8me"}},"dur\xe9e":(e,t)=>{const n=((e,t,n)=>{const r={};for(const a in e){const i=e[a];if(null==t[a]&&!i)throw new m("EngineError",`Il manque une cl\xe9 '${a}' dans ${JSON.stringify(t)} `,{});const s=null!=t[a]?jn(t[a],n):i;r[a]=s}return r})(Ke,e,t);return{explanation:n,unit:ae("jour"),nodeKind:"dur\xe9e"}},grille:function(e,t){return{explanation:{assiette:jn(e.assiette,t),multiplicateur:e.multiplicateur?jn(e.multiplicateur,t):re(1),tranches:Oe(e.tranches,t)},nodeKind:"grille"}},multiplication:Wt,produit:Wt,recalcul:(e,t)=>{const n=Object.keys(e.avec).map((n=>[jn(n,t),jn(e.avec[n],t)]));return{explanation:{recalculNode:jn(e.r\u00e8gle??t.dottedName,t),amendedSituation:n},nodeKind:"recalcul"}},somme:Tt,moyenne:Dt,[Xt.nom]:Xt,valeur:jn,variable:function(e,t){if(!t.dottedName)throw new f({message:"Une r\xe9f\xe9rence ne peut pas exister en dehors d'une r\xe8gle (`context.dottedName` est vide)",context:t});return{nodeKind:"reference",name:e,contextDottedName:t.dottedName}},variations:function(e,t){return{explanation:e.map((e=>{let{si:n,alors:r,sinon:a}=e;return void 0!==a?{consequence:jn(a,t),condition:re(!0)}:{consequence:jn(r,t),condition:jn(n,t)}})),nodeKind:"variations"}},constant:e=>({type:e.type,fullPrecision:!0,isNullable:null==e.nodeValue,missingVariables:{},nodeValue:e.nodeValue,nodeKind:"constant"})},kn=Object.keys($n);function En(e){return{dottedName:"",logger:console,getUnitKey:e=>e,parsedRules:{},referencesMaps:{referencesIn:new Map,rulesThatUse:new Map},nodesTypes:new WeakMap,rulesReplacements:{},...e}}function Sn(e){return{...e,parsedRules:{...e.parsedRules},referencesMaps:{referencesIn:new Map(e.referencesMaps.referencesIn),rulesThatUse:new Map(e.referencesMaps.rulesThatUse)}}}function Rn(e,t){if(void 0===t&&(t=En({})),"string"==typeof e)throw new m("EngineError","Publicodes does not parse yaml rule sets itself anymore. Please provide a parsed js object. E.g. the `eemeli/yaml` package.",{});let n=y(e);const r=En(t);let a=r.parsedRules;r.parsedRules={};for(const u in n){let e=n[u];if("string"!=typeof e&&"number"!=typeof e||(e={valeur:`${e}`}),"object"!=typeof e)throw new m("SyntaxError",`Rule ${u} is incorrectly written. Please give it a proper value.`,{dottedName:u});const t=y(e);t.nom=u,jn(t,r)}let i={};for(const u in a)i[u]=a[u];for(const u in r.parsedRules)i[u]=r.parsedRules[u];let s,[o,l]=function(e,t,n){const r=j((t=>Nt(t,e))),a=j((t=>{const r=Nt(t,e);return r&&jt(r,n),r})),i=function(e,t){const n={};for(const r in t)n[r]=e(t[r]);return n}((e=>"replacementRule"===e.nodeKind?r(e):a(e)),t);return[i,n]}(i,r.parsedRules,r.referencesMaps);[i,s]=Et({parsedRules:i,newRules:o,referencesMaps:l,previousReplacements:r.rulesReplacements,logger:r.logger});return{parsedRules:i,nodesTypes:F(Object.keys(o),i,r.nodesTypes),referencesMaps:l,rulesReplacements:s}}var On=()=>({_meta:{evaluationRuleStack:[],parentRuleStack:[],traversedVariablesStack:[]},nodes:new Map}),In=class e{baseContext;context;publicParsedRules;cache=On();subEngines=[];subEngineId;constructor(e,t){void 0===e&&(e={}),void 0===t&&(t={});const n={dottedName:"",...t};this.baseContext=En({...n,...Rn(e,n)}),this.context=this.baseContext,this.publicParsedRules={};for(const r in this.baseContext.parsedRules){const e=this.baseContext.parsedRules[r];!e.private&&vt(this.baseContext.parsedRules,"",r)&&(this.publicParsedRules[r]=e)}}resetCache(){this.cache=On()}setSituation(e,t){void 0===e&&(e={}),void 0===t&&(t={}),this.resetCache();const n=t.keepPreviousSituation??!1;Object.keys(e).forEach((e=>{if(!(e in this.baseContext.parsedRules))throw new m("EvaluationError",`Erreur lors de la mise \xe0 jour de la situation : ${e} n'existe pas dans la base de r\xe8gle.`,{dottedName:e});if(this.baseContext.parsedRules[e].private)throw new m("EvaluationError",`Erreur lors de la mise \xe0 jour de la situation : ${e} est une r\xe8gle priv\xe9e (il n'est pas possible de modifier une r\xe8gle priv\xe9e).`,{dottedName:e})}));const r=Object.fromEntries(Object.entries(e).map((e=>{let[t,n]=e;return[`[priv\xe9] ${t} . $SITUATION`,n&&"object"==typeof n&&"nodeKind"in n?{valeur:n}:n]}))),a=Sn(this.baseContext);try{this.context={...this.baseContext,...Rn(r,n?this.context:this.baseContext)}}catch(i){throw this.baseContext=a,i}return this.baseContext=a,Object.keys(e).forEach((e=>{gt(this.context.parsedRules,e)&&g(this.baseContext.logger,e),this.checkExperimentalRule(this.context.parsedRules[`${e} . $SITUATION`])})),this}inversionFail(){return!!this.cache.inversionFail}getRule(e){if(!(e in this.baseContext.parsedRules))throw new m("UnknownRule",`La r\xe8gle '${e}' n'existe pas`,{dottedName:e});if(!(e in this.publicParsedRules))throw new m("PrivateRule",`La r\xe8gle ${e} est une r\xe8gle priv\xe9e.`,{dottedName:e});return this.publicParsedRules[e]}getParsedRules(){return this.publicParsedRules}evaluate(e){const t=this.cache.nodes.get(e);if(t)return t;this.context={...this.context,...Rn({"[priv\xe9] $EVALUATION":e&&"object"==typeof e&&"nodeKind"in e?{valeur:e}:e},this.context)},this.checkExperimentalRule(this.context.parsedRules.$EVALUATION),this.cache._meta=On()._meta;const n=this.evaluateNode(this.context.parsedRules.$EVALUATION.explanation.valeur);return this.cache.nodes.set(e,n),n}evaluateNode(e){const t=this.cache.nodes.get(e);if(void 0!==t)return t.traversedVariables?.forEach((e=>this.cache._meta.traversedVariablesStack[0]?.add(e))),t;if(!U[e.nodeKind])throw new m("EvaluationError",`Unknown "nodeKind": ${e.nodeKind}`,{dottedName:""});const n=0===this.cache._meta.traversedVariablesStack.length||"rule"===e.nodeKind;n&&this.cache._meta.traversedVariablesStack.unshift(new Set),"reference"===e.nodeKind&&e.dottedName&&e.dottedName in this.publicParsedRules&&this.cache._meta.traversedVariablesStack[0].add(e.dottedName);const r=U[e.nodeKind].call(this,e);return n&&(r.traversedVariables=Array.from(this.cache._meta.traversedVariablesStack.shift()??[]),this.cache._meta.traversedVariablesStack.length>0&&r.traversedVariables.forEach((e=>{this.cache._meta.traversedVariablesStack[0].add(e)}))),this.cache.nodes.set(e,r),r}shallowCopy(){const t=new e;return t.baseContext=Sn(this.baseContext),t.context=Sn(this.context),t.publicParsedRules=this.publicParsedRules,t.cache={...On(),nodes:new Map(this.cache.nodes)},t}checkExperimentalRule=N((e=>("reference"===e.nodeKind&&gt(this.context.parsedRules,e.dottedName)&&g(this.baseContext.logger,e.dottedName),"continue")))}}}]);
//# sourceMappingURL=364.d0c4a9b0.js.map